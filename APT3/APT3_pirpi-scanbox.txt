a tale of pirpi, scanbox & cve-2015-3113
23 july 2015 by tom lancaster executive summary in the past year, pwc has notified the public about developments relating to the scanbox reconnaissance framework on several occasions. there has recently been public reporting[1] which relates to possible deployment of malware via scanbox for the first time. while the report references activity related to a zero-day exploit against adobe flash (cve-2015-3113), it does not detail the delivery mechanism used for this zero-day, which in fact uses scanbox as part of the process. in the second of our public scanbox reports[2], we reported that in addition to attackers using the framework in conjunction with strategic web compromises (swcs), we were also observing the attackers sending phishing emails to targets. we referred to this as phishing at the watering hole (figure 1). this short blog, available to our intelligence customers since the 3rd july, details this technique in action and how a variant of scanbox is used to infect victims with the pirpi malware. figure 1 figure 1 phishing at the watering hole an explanation of how attackers used scanbox with phishing attacks initially. analysis
since our initial report in february 2015, it has become apparent that the threat actor behind this particular set of emails was apt3 or gothic panda, often referred to in the open source as pirpi . the attackers were sending emails where victims would be linked both to a website the attacker had compromised, and in another tab to the genuine content they were expecting. at present, we have no reason to believe that any malware was served to visitors when this technique was used in early january, beyond the scanbox keylogging and profiling of visiting machines. however, this was not the only time that pirpi used scanbox they continued to send phishing emails to organisations across a variety of sectors, using a similar technique to open a second tab of legitimate content. in their most recent rounds of phishing, and possibly in rounds before, the pirpi attackers used the scanbox framework to profile victims, and then select those who met the given requirements for infection. this is effectively the same principle as that behind most of the popular exploit kits where once victims meet a specific set of requirements, they are served an exploit. in this case it is believed that whitelist by version of windows/flash was the requirement for infection. it is unclear at present if victims were also selected by their ip address being whitelisted or not. the chain of infection for the flash zero-day when used in conjunction with scanbox is as follows: victim receives phishing email, with link to compromised site, with a unique one-time-use landing page per victim.
compromised site includes javascript containing an obfuscated version of plugindetect[3], fused with previously existing scanbox code.
after a 0.4 second delay, the framework attempts to load the flash zero day for qualifying victims.
obfuscated plugindetect
the obfuscation for plugindetect was fairly basic, and worked by building a huge array of strings in hexadecimal characters, these were then converted to ascii and substituted into the relevant functions in which they were required. to illustrate how this might appear, the same function is given side by side in figure 2. figure 2.1 figure 2.2 figure 2 the code used, shown first pre deobfuscation, and then afterwards once substituted, the code is slightly more readable; however the attackers have also used a set of variable names likely to have been also substituted in an automated fashion, which makes things more difficult. however we can still clearly see that the code matches that which can be built on the pinlady website[4]. closing notes
we believe the primary benefit to the attacker of using the scanbox framework to wrap the plugindetect code, rather using just the plugindetect on its own, is that they are able to better record success rate of infections. as discussed in our subscriber only article scanbox going serverside (cto-tib-20150430-0b), the scanbox server side code gives the attackers techniques which allow them to whitelist visitors, as well as track their results in a back end database. the pirpi attackers are becoming increasingly well known for these attacks, following a number of public reports on the group, it is unclear if the repeated public coverage they are currently receiving will lead to a change in tactics by the group, who have used broadly the same tactics, techniques and procedures (ttps) for the past few years. pwc intelligence customers have access to indicators and associated ids rules in report cto-tib-20150703-01a. further information
we specialise in providing the services required to help clients resist, detect and respond to advanced cyber-attacks. this includes crisis events such as data breaches, economic espionage and targeted intrusions, including those commonly referred to as apts. if you would like more information on any of the threats discussed in this bulletin please feel free to get in touch, by e-mailing threatintelligence@ . 