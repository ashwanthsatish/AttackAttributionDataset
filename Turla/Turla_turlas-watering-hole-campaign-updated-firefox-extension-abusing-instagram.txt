turla s watering hole campaign: an updated firefox extension abusing instagram
the turla espionage group is still using watering hole techniques to redirect potentially interesting victims to their c&c infrastructure. jean-ian boutin
jean-ian boutin	6 jun 2017 - 02:00pm update, 21 june 2017: due to our misunderstanding of communications with google, the firefox extension s infection vector discussed below was wrongly described here on 06 june 2017; this is now corrected. apologies to google and our readers for the unintentional misrepresentation in our original post. some of the tactics used in apt attacks die hard. a good example is provided by turla s watering hole campaigns. turla, which has been targeting governments, government officials and diplomats for years see, as an example, this recent paper is still using watering hole techniques to redirect potentially interesting victims to their c&c infrastructure. in fact, they have been using them since at least 2014 with very few variations in their modus operandi. a watering hole attack compromises websites that are likely to be visited by targets of interest. the people behind turla are apparently keen on targeting embassy websites. indeed, there was a february 2017 blogpost by forcepoint highlighting some of the websites most recently compromised. we, of course, are monitoring the developments of these campaigns closely and recently noticed them reusing a technique that we haven t seen them use for several months. initial compromise
in the iocs section below, there is a list of websites that have been used to redirect to turla watering hole c&cs in the past. as is usual with this group, there are many websites directly related to embassies throughout the world. the websites visitors will be redirected to a malicious server because of a snippet inserted by the attacker appended to the original page. the scripts we saw in the last few months were all similar to this one:
the attackers added a reference to clicky, a real time web analytics framework. they are adding this framework name in an attempt to legitimize the appended script to cursory, or non-expert, examination, although it is not actually used in the attack. we can see here that this injected script calls another script at . this is a server the turla gang has been using to push fingerprinting scripts scripts that will gather information about the system it is running on to interesting victims. a deceptive reference to the google analytics script was used in a similar fashion for a while, but now clicky is what we see the most. you can find in the iocs section the various watering hole c&cs that we saw in the last couple of months. all of these c&cs are compromised legitimate servers. the next step in the attack is to distribute a fingerprinting javascript to interesting targets. to do this, the c&c is filtering visitors using an ip range. if they are within the targeted ip range, they receive the fingerprinting script. if not, they just receive a benign script: a js implementation of the md5 hashing algorithm. below we show an excerpt of the deobfuscated script that is received by victims coming from a targeted ip range: this javascript will download a js library called plugindetect that has the ability to collect information about plugins installed in the browser. the information collected is then sent to the c&c server. it will also try to install an evercookie, or so-called super cookie, that will track the user throughout his browsing, across all sites on the internet. for those familiar with this group s waterholing techniques, it is clear they are still using their old, publicly known tried-and-true methods. firefox extension
through our monitoring of these watering hole campaigns, we happened upon a very interesting sample. some of you may remember the pacifier apt report by bitdefender describing a spearphishing campaign with a malicious microsoft word document sent to several institutions worldwide. these malicious documents would then drop a backdoor. we now know that this report describes skipper, a first stage backdoor used by the turla gang. that report also contains a description of a firefox extension dropped by the same type of malicious document. it turns out we have found what most likely is an update of this firefox extension. it is a javascript backdoor, different in terms of implementation to the one described in the pacifier apt report, but with similar functionalities. turla we noticed that this extension could have been distributed through a forged copy of a swiss security company s website. unsuspecting visitors to this website were asked to install this malicious extension. the extension is a simple backdoor, but with an interesting way of fetching its c&c domain. the use of instagram
the extension uses a url to reach its c&c, but the url path is nowhere to be found in the extension code. in fact, it will obtain this path by using comments posted on a specific instagram post. the one that was used in the analyzed sample was a comment about a photo posted to the britney spears official instagram account. the extension will look at each photo s comment and will compute a custom hash value. if the hash matches 183, it will then run this regular expression on the comment in order to obtain the path of the url: looking at the photo s comments, there was only one for which the hash matches 183. this comment was posted on february 6, while the original photo was posted in early january. taking the comment and running it through the regex, you get the following url: looking a bit more closely at the regular expression, we see it is looking for either @|# or the unicode character \200d. this character is actually a non-printable character called zero width joiner , normally used to separate emojis. pasting the actual comment or looking at its source, you can see that this character precedes each character that makes the path of the url: when resolving this shortened link, it leads to , which was used in the past as a watering hole c&c by the turla crew. as is the case with all links, it is possible to get statistics on who clicked the link. turla as seen above, there were only 17 hits recorded on this link in february, right around the time the comment was posted. however, this is quite a low number and might indicate that it was only a test run. technical analysis
this firefox extension implements a simple backdoor. it will first gather information on the system it is running on and send it to the c&c, encrypted using aes. this is very similar to what the extension described in the pacifier apt white paper is doing. the backdoor component has the ability to run four different types of commands: execute arbitrary file
upload file to c&c
download file from c&c
read directory content send a file listing, along with sizes and dates, to c&c
while we believe this to be some type of test, the next version of the extension if there is one is likely to be very different. there are several apis that are used by the extension that will disappear in future versions of firefox. for example, it uses xpcom to write files to disk and sdk/system/child_process to launch a process. these can only be used by add-ons that will be superseded by webextensions starting with firefox 57. from that version onwards, firefox will no longer load add-ons, thus preventing the use of these apis. conclusion
the fact that the turla actors are using social media as a way to obtain its c&c servers is quite interesting. this behavior has already been observed in the past by other threat crews such as the dukes. attackers using social media to recover a c&c address are making life harder for defenders. firstly, it is difficult to distinguish malicious traffic to social media from legitimate traffic. secondly, it gives the attackers more flexibility when it comes to changing the c&c address as well as erasing all traces of it. it is also interesting to see that they are recycling an old way of fingerprinting a victim and finding new ways to make the c&c retrieval a bit more difficult. for any inquiries, or to make sample submissions related to the subject, contact us at: threatintel@ . acknowledgements
we would like to thank clement lecigne from google s threat analysis group for his help researching this campaign. 