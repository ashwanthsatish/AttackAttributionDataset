friday, may 12, 2017
player 3 has entered the game: say hello to 'wannacry'
this post was authored by martin lee, warren mercer, paul rascagneres, and craig williams. executive summary a major ransomware attack has affected many organizations across the world reportedly including telefonica in spain, the national health service in the uk, and fedex in the us. the malware responsible for this attack is a ransomware variant known as 'wannacry'. the malware then has the capability to scan heavily over tcp port 445 (server message block/smb), spreading similar to a worm, compromising hosts, encrypting files stored on them then demanding a ransom payment in the form of bitcoin. it is important to note that this is not a threat that simply scans internal ranges to identify where to spread, it is also capable of spreading based on vulnerabilities it finds in other externally facing hosts across the internet. additionally, talos has observed wannacry samples making use of doublepulsar which is a persistent backdoor that is generally used to access and execute code on previously compromised systems. this allows for the installation and activation of additional software, such as malware. this backdoor is typically installed following successful exploitation of smb vulnerabilities addressed as part of microsoft security bulletin ms17-010. this backdoor is associated with an offensive exploitation framework that was released as part of the shadow brokers cache that was recently released to the public. since its release it has been widely analyzed and studied by the security industry as well as on various underground hacking forums. wannacry appears to primarily utilize the eternalblue modules and the doublepulsar backdoor. the malware uses eternalblue for the initial exploitation of the smb vulnerability. if successful it will then implant the doublepulsar backdoor and utilize it to install the malware. if the doublepulsar backdoor is already installed the malware will still leverage this to install the ransomware payload. this is the cause of the worm-like activity that has been widely observed across the internet organizations should ensure that devices running windows are fully patched and deployed in accordance with best practices. additionally, organizations should have smb ports (139, 445) blocked from all externally accessible hosts. please note this threat is still under active investigation, the situation may change as we learn more or as our adversary responds to our actions. talos will continue to actively monitor and analyze this situation for new developments and respond accordingly. as a result, new coverage may be developed or existing coverage adapted and/or modified at a later date. for current information, please refer to your firepower management center or . campaign details
we observed an uptick in scanning of our internet facing honeypots starting shortly before 5am est (9am utc). infrastructure analysis
cisco umbrella researchers first observed requests for one of wannacry's killswitch domains (iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea[.]com) starting at 07:24 utc, then rising to a peak of just over 1,400 nearly 10 hours later. the domain composition looks almost human typed, with most characters falling into the top and home rows of a keyboard. communication to this domain might be categorized as a kill switch domain due to its role in the overall execution of the malware: the above subroutine attempts an http get to this domain, and if it fails, continues to carry out the infection. however if it succeeds, the subroutine exits. the domain is registered to a well known sinkhole, effectively causing this sample to terminate its malicious activity. the raw registration information re-enforces this as it was registered on 12 may 2017: malware analysis
an initial file " " drops and executes " ", this exe tests the kill switch domains. one complete, the service mssecsvc2.0 is created, this is a method of persistance for the malware. this service executes " " with a different entry point than the initial execution. this second execution executes 2 threads. the first thread checks the ip address of the infected machine and attempts to connect to tcp445 (smb) of each host/ip address in the same subnet and second thread generates random ip address on the internet to perform the same action. when the malware successfully connects to a machine, a connection is initiated and data is transferred. the malware exploits the smb vulnerability addressed by microsoft in the bulletin ms17-010 (eternalblue) in order to implant the doublepulsar backdoor. the backdoor is used to execute wannacry on the new compromised system. the file checks for disk drives, including network shares and removable storage devices mapped to a letter, such as 'c:/', 'd:/' etc. the malware then checks for files with a file extension as listed in the appendix and encrypts these using 2048-bit rsa encryption. while the files are being encrypted, the malware creates a new file directory 'tor/' into which it drops and nine dll files used by . additionally, it drops two further files: & . the former deletes temporary files while the latter launches to display the ransom note on the desktop to the end user. the is not in and of itself the ransomware, only the ransom note. the encryption is performed in the background by . the file is executed by . this newly executed process initiates network connections to tor nodes. this allows wannacry to attempt to preserve anonymity by proxying their traffic through the tor network. typical of other ransomware variants, the malware also deletes any shadow copies on the victim's machine in order to make recovery more difficult. it achieve this by using , and . wannacry uses various methods to attempt to aid its execution by leveraging both to modify the +h flag (hide) and also to allow full access rights for all users, "icacls . /grant everyone:f /t /c /q" the malware has been designed as a modular service. it appears to us that the executable files associated with the ransomware have been written by a different individual than whomever developed the service module. potentially, this means that the structure of this malware can be used to deliver and run different malicious payloads. after encryption is complete, the malware displays the following ransomware note. one interesting aspect of this ransomware variant is that the ransom screen is actually an executable and not an image, hta file, or text file. organisations should be aware that there is no obligation for criminals to supply decryption keys following the payment of a ransom. talos strongly urges anyone who has been compromised to avoid paying the ransom if possible as paying the ransom directly funds development of these malicious campaigns. mitigation and prevention
organizations looking to mitigate the risk of becoming compromised should follow the following recommendations: ensure all windows-based systems are fully patched. at a very minimum, ensure microsoft bulletin ms17-010 has been applied.
in accordance with known best practices, any organization who has smb publically accessible via the internet (ports 139, 445) should immediately block inbound traffic. additionally, organizations should strongly consider blocking connections to tor nodes and tor traffic on network. known tor exit nodes are listed within the security intelligence feed of asa firepower devices. enabling this to be blacklisted will prevent outbound communications to tor networks. in addition to the mitigations listed above, talos strongly encourages organizations take the following industry-standard recommended best practices to prevent attacks and campaigns like this and similar ones. ensure your organization is running an actively supported operating system that receives security updates.
have effective patch management that deploys security updates to endpoints and other critical parts of your infrastructure in a timely manner.
run anti-malware software on your system and ensure you regularly receive malware signature updates.
implement a disaster recovery plan that includes backing up and restoring data from devices that are kept offline. adversaries frequently target backup mechanisms to limit the possibilities a user may be able to restore their files without paying the ransom.
coverage
snort rule: 42329-42332, 42340, 41978 open source snort subscriber rule set customers can stay up to date by downloading the latest rule pack available for purchase on . additional ways our customers can detect and block this threat are listed below. advanced malware protection (amp) is ideally suited to prevent the execution of the malware used by these threat actors. cws or wsa web scanning prevents access to malicious websites and detects malware used in these attacks. network security appliances such as ngfw, ngips, and meraki mx can detect malicious activity associated with this threat. amp threat grid helps identify malicious binaries and build protection into all cisco security products. umbrella prevents dns resolution of the domains associated with malicious activity. stealthwatch detects network scanning activity, network propagation, and connections to cnc infrastructures, correlating this activity to alert administrators. 