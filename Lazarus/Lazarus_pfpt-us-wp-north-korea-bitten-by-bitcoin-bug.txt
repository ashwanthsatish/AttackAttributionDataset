financially motivated campaigns
reveal new dimension of the
lazarus group
north korea
bitten by
bitcoin bug
darien huss
table of contents
executive summary
with activity dating at least to 2009, the lazarus group has consistently ranked among the most disruptive, successful,
and far-reaching nation-state sponsored actors. the march 20, 2013 attack in south korea, the sony pictures hack in 2014,
the successful theft of $81 million from the bangladesh bank in 2014, and perhaps most famously this year s wannacry
ransomware attack and its global impact have all been attributed to the group. the lazarus group is widely accepted as
being a north korean state-sponsored threat actor by numerous organizations in the information security industry, law
enforcement agencies, and intelligence agencies around the world.
the lazarus group s arsenal of tools, implants, and exploits is extensive and under constant development. previously,
they have employed ddos botnets, wiper malware to temporarily incapacitate a company, and a sophisticated set of
malware targeting the swift banking system to steal millions of dollars. in this report we describe and analyze a new,
currently undocumented subset of the lazarus group s toolset that has been widely targeting individuals, companies, and
organizations with interests in cryptocurrency.
threat vectors for this new toolset, dubbed powerratankba, include highly targeted spearphishing campaigns using
links and attachments as well as massive email phishing campaigns targeting both personal and corporate accounts of
individuals with interests in cryptocurrency. we also share our discovery of what may be the frst publicly documented
instance of a nation-state targeting a point-of-sale related framework for the theft of credit card data, again using a variant
of malware that is closely related to powerratankba.
overview
the lazarus group has increasingly focused on fnancially motivated attacks and appears to be capitalizing on both the
increasing interest and skyrocketing prices for cryptocurrencies. proofpoint researchers have uncovered a number of
multistage attacks that use cryptocurrency-related lures to infect victims with sophisticated backdoors and reconnaissance
malware. victims of interest are then infected with additional malware including gh0st rat to steal credentials for
cryptocurrency wallets and exchanges, enabling the lazarus group to conduct lucrative operations stealing bitcoin and
other cryptocurrencies. we also discovered what appears to be the frst publicly documented instance of a nation-state
targeting a point-of-sale related framework for the theft of credit card data in a related set of attacks. moreover, the timing of
the point-of-sale related attacks near the holiday shopping season makes the potential fnancial losses considerable.
introduction
it is already well-known that lazarus group has targeted and successfully breached several prominent cryptocurrency
companies and exchanges. from these breaches, law enforcement agencies suspect that the group has amassed nearly
$100 million worth of cryptocurrencies based on their value today. we hypothesize that many of these previously reported
operations targeting cryptocurrency organizations have actually been conducted by the espionage team of the lazarus
group based on evidence we provide in the attribution section. further, we assess that until today, many of lazarus
group s traditional fnancially motivated team have remained largely in the shadows as they conduct these operations
adding to their already impressive stockpile of various cryptocurrencies.
several watering hole attacks targeting the banking and fnancial industries that occurred at the end of 2016 and beginning
of 2017 utilized a frst stage downloader implant dubbed ratankba. during those incidents, lazarus group primarily used
ratankba as a reconnaissance tool, described by colleagues at trend micro as a utility to survey the lay of the land. in
this research we detail a new implant dubbed powerratankba, a powershell-based malware variant that closely resembles
the original ratankba implant. we believe that powerratankba was likely developed as a replacement in lazarus group s
strictly fnancially motivated team s arsenal to fll the hole left by ratankba s discovery and very public documentation
earlier this year.
in this report, we frst provide a brief timeline of events related to the malicious activity. next, we describe the various
delivery methods that lazarus group utilized to infect victims with powerratankba (fig. 1). we then detail the inner
workings of powerratankba and how it is utilized to deliver a more fully capable backdoor to interesting victims (fig. 1).
following that, we share details on a new and emerging threat targeting the south korean point-of-sale industry that we
have dubbed ratankbapos (fig. 1). finally, we explain our high-confdence attribution to lazarus group.
figure 1: flow of powerratankba activity from victims to the lazarus group operators
powerratankba downloaders
in this section we will detail each of the different attack vectors and campaigns we have discovered that eventually lead to
the delivery of powerratankba. in total we have discovered six different attack vectors: a new windows executable downloader dubbed powerspritz a malicious windows shortcut (lnk) fle several malicious microsoft compiled html help (chm) fles using two different techniques multiple javascript (js) downloaders two macro-based microsoft offce documents two campaigns utilizing backdoored popular cryptocurrency applications hosted on internationalized domain (idn)
infrastructure to trick victims into thinking they were on a legitimate website
campaign timeline
the campaigns discussed in this research began on or around june 30th, 2017. according to our data those campaigns
were highly targeted spearphishing attacks targeting at least one executive at a cryptocurrency organization to deliver a
powerratankba.a variant. all other campaigns utilized variants. we currently have no visibility into how
the lnk, chm, and js campaigns were delivered to users, but given common lazarus modus operandi, we can speculate
that they may have been delivered through attachments or links in emails. we gained visibility again during the massive
email campaigns utilizing btg- and electrum-themed applications to ultimately deliver powerratankba. the timeline below
illustrates the exact dates of campaigns where we are aware of them. where exact dates are unknown, we based estimates
on frst campaign observations and metadata (fig. 2).
figure 2: timeline of campaigns ultimately related to powerratankba
powerspritz
powerspritz is a windows executable that hides both its legitimate payload and malicious powershell command using
a non-standard implementation of the already rarely used spritz encryption algorithm (see the attribution section for
additional analysis of the spritz implementation). this malicious downloader has been observed being delivered via
spearphishing attacks using the tinycc link shortener service to redirect to likely attacker-controlled servers hosting the
malicious powerspritz payload. in early july 2017 an individual on twitter shared an attack they observed targeting them
(fig. 3) utilizing a fake skype update lure to trick users into clicking on a link to hxxps://skype.2[.]vu/1. the tinycc link
redirected to a server that, at the time, would have likely returned a powerspritz payload: hxxp://201.211.183[.]215:8080/
update.php?t=skype&r=update
figure 3: powerspritz spearphishing email shared on twitter by @leoaw, abusing skype name and branding
we have since discovered three additional tinycc urls utilized to spread powerspritz: one with a telegram theme (hxxp://
telegramupdate.2[.]vu/5 -> hxxp://122.248.34[.]23/lndex.php?t=telegram&r=1.1.9) and two more with skype theme
(hxxp://skypeupdate.2[.]vu/1 -> hxxp://122.248.34[.]23/lndex.php?t=skypesetup&r=mail_new and hxxp://skype.2[.]vu/k
-> unknown). some of the powerspritz payloads were previously hosted on google drive; however, we were unable to
determine if that service was actually used to spread the payloads in-the-wild (itw).
powerspritz decrypts a legitimate skype or telegram installer using a custom spritz implementation with the key znxkai@
if8qa9w9489 . powerspritz then writes the legitimate installer to disk in the directory returned by gettemppatha either as
a hardcoded flename such as or, in some versions, as the flename returned by gettempfilenamea.
the installer is then executed to trick the potential victim into thinking they downloaded a legitimate, working application
installer or update. finally, spritz uses the same key to decrypt a powershell command that downloads the frst stage of
powerratankba (fig. 4). all three powerspritz samples we discovered executed the identical powershell command.
figure 4: script output showing powerspritz powershell encoded and decoded command
as shown in the above decoded script (fig. 4), powerspritz attempts to retrieve a payload from hxxp://dogecoin.
deaftone[.]com:8080/ that is expected to be a base64-encoded powershell script. after decoding ,
a powerratankba.a implant is revealed (fig. 5) with hxxp://vietcasino.linkpc[.]net:8080/search.jsp as its command and
control (c&c).
figure 5: powerspritz retrieving base64-encoded powerratankba
windows shortcut (lnk)
a lnk masquerading as a pdf document was discovered on an antivirus
scanning service. the malicious scanned document part lnk fle, along with a corrupted pdf named scanned document part , were compressed in a zip fle named scanned (fig. 6). it is unclear if the pdf document was tampered with intentionally
to increase the chances a target would open the malicious lnk or if the
actor(s) unintentionally used a corrupted document. we currently are not
aware of how the lnk or compressed zip fles were utilized itw.
the malicious lnk uses a known applocker bypass to retrieve its
payload from a tinyurl shortener link hxxp://tinyurl[.]com/y9jbk8cg (fig.
7). this shortener previously redirected to hxxp://201.211.183[.]215:8080/
pdfviewer.php?o=0&t=report&m=0 . at the time of analysis the c&c
server was no longer returning payloads. however, the same ip was
used in the powerspritz campaigns. based on the same c&c usage
and similar uri structure, we assess with low confdence that the lnk
campaign would have delivered powerratankba via powerspritz.
figure 7: malicious lnk applocker bypass to retrieve payload
figure 6: zip fle with decompressed
malicious lnk and corrupted pdf
microsoft compiled html help (chm)
several malicious chm fles were uploaded to a multi antivirus scanning service in october, november, and december. we
inspected the compressed zip metadata to better understand the likely chronological order in which the chms were used.
unfortunately we have been unable to determine how these infection attempts were delivered to victims itw. the themes of
the malicious chms include: a confusing, poorly written request for assistance with creating a website with possible romantic undertones (fig. 8-1) documentation on a blockchain technology called alchain from orient exchange co. (fig. 8-2) a request for assistance in developing an initial coin offering (ico) platform (fig. 8-3) white paper on the falcon coin ico (fig. 8-4) a request for applications to develop a cryptocurrency exchange platform (fig. 8-5) a request for assistance in creating an email marketing tool (fig. 8-6)
figure 8: chm lures utilized in attempts to deliver powerratankba
all of the chm fles use a well-known technique to create a shortcut object capable of executing malicious code and then
causing that shortcut object to be automatically clicked via the x.click(); function. two different methods were used
across the chms to retrieve the malicious payload.
the frst method uses a vbscript execute command and bitsadmin tool to download a malicious vbscript fle (fig.
9). the payload is downloaded (fig. 10) from hxxp://www.businesshop[.]net/hide.gif and saved to c:\windows\temp\
poweropt.vbs. once the downloaded vbscript (fig. 10) is executed, it will attempt to download powerratankba from
hxxp://158.69.57[.]135/ , saving the expected powershell script to c:\users\public\pictures\opt.ps1.
figure 9: malicious code embedded in chm to download a vbscript powerratankba downloader
figure 10: bitsadmin retrieving malicious payload over http
figure 10: bitsadmin retrieving malicious payload over http
the second method downloads a similar vbscript-based powerratankba downloader using powershell directly in the
chm (fig. 11). a similar vbscript execute command is utilized to call powershell s downloadstring to execute the payload
directly from hxxp://92.222.106[.]229/ figure 11: powershell utilized in chm to retrieve powerratankba downloader vbs
the 5_6283065828631904327.chm ( )
contains notable pieces of unused code as well as code pointing to an rfc1918 private ip address in the decompressed
doc.htm fle (fig. 12). the frst excerpt of unused code consists of a more traditional powershell command that downloads
a script from hxxp://192.168.102[.]21/power.ps1. the next block of code adds an obfuscation technique (also present in
other related chms) where the quotes are replaced with the * character. this obfuscated code downloads a powershell
payload from the same rfc1918 address but from a different uri: hxxp://192.168.102[.]21/pso.ps1. we assess that this
is likely a remnant of the author developing the malicious chm method using their local environment rather than using
code stolen from an unrelated chm, tool, or other malicious payload. additionally, another piece of commented code
follows which executes a vbscript fle c:\users\dolphinepc\downloads\run_32.vbs . this may offer another clue to the
developer s environment that has a possible username of dolphinepc. finally, a implant was embedded
in the same chm as aa.ps1 and confgured with c&c servers of 92.222.106[.]229 and 158.69.57[.]135.
figure 12: leftover code in 5_6283065828631904327.chm
as a fnal note on the chm campaigns, the following three samples contain an email address of either robert_mobile@
gmail[.]com or robert_mobile@mail[.]com, which we assess with some confdence are related to the threat actor:
javascript downloaders
throughout november several compressed zip fles containing a javascript (js) downloader were observed being hosted
on likely attacker-controlled servers. we are not currently aware if or how these fles were delivered to potential victims. the
naming of the fles and the decoy pdf documents they retrieve provide some clues about the nature of the lures. themes
include the cryptocurrency exchanges coinbase and bithumb, the falcon coin ico, and a list of bitcoin transactions.
each javascript downloader is obfuscated (fig. 13) using javascript obfuscator (see attribution section for additional
analysis) or a similar tool. after de-obfuscating (fig. 14), the logic of the malicious downloader is very straightforward. first,
an obfuscated powershell script is downloaded from a fake image url such as: hxxp://51.255.219[.]82/ . next, the powershell script is saved to c:\users\public\pictures\opt.ps1 and then executed.
the last step in execution is to retrieve the decoy pdf from hxxp://51.255.219[.]82/fles/download/falconcoin.pdf and open
it using and ,openas_rundll (fig. 15-1). samples using coinbase and bithumb themes also
downloaded pdf decoys (fig. 15-2,15-3). additionally we discovered that the content from the coinbase decoy has been
used in lazarus group-attributed espionage campaigns (see attribution for more details).
figure 15: decoys downloaded or sent along with powerratankba javascript downloaders
vbscript macro microsoft office documents
two vbscript macro-laden microsoft offce documents have been observed associated with this activity: one word
document and one excel spreadsheet. the word document (b3235a703026b2077ccfa20b3dabd82d65c6b5645f7f1
5e7bbad1ce8173c7960) uses an internal revenue service (irs) theme and was sent as an attachment named report . the spearphishing email was sent from an @ address with the subject of phishing warnning [sic].
ironically, the sender email address was spoofed as phishing@ (fig. 16) while the content of the lure (fig. 17) was
likely copied from an offcial irs webpage.
figure 16: spearphishing email spoofed sender
and subject
figure 17: irs themed word document powerratankba
downloader
the irs-themed malicious document uses a macro
figure 18: irs-themed malicious document macro
the second malicious offce document we discovered is an excel spreadsheet named . it uses a bithumb lure
(fig. 19) and includes stolen branding. the spreadsheet was found compressed in a zip fle named along with
a decoy pdf document named about (fig. 20).
figure 19: malicious bithumb excel spreadsheet with english option shown, with stolen branding
figure 20: about decoy document inside archive, with stolen branding
the excel spreadsheet contains a macro with an embedded base64-encoded powerratankba vbscript downloader
backdoored pyinstaller applications
most recently, several large email phishing campaigns attempted to trick unsuspecting victims into visiting fake webpages
to download or update cryptocurrency applications. the copycat websites were mirror images of legitimate websites with
software download links pointing to the correct installers hosted on the legitimate websites. the only exception was the
link to download the windows version of the application, which was hosted on the copycat websites. these pyinstaller
executables were backdoored with a few lines of python code added to download the powerratankba implant.
the frst campaign that utilized this technique used a bitcoin gold (btg) theme to trick the targets into visiting an
internationalized domain name (idn) website (fig. 22). an email was sent to targets offering a btg wallet application
along with a link to the malicious website: hxxps://xn--bitcoingld-lcb[.]org/. however, web browsers and email clients would
display the link as follows: hxxps://bitcoing ld[.]org/. emails in this btg campaign were sent between approximately
november 10-16, 2017. some of the known sender emails include but are not limited to: info@xn--bitcoingod-8yb[.]com,
info@xn--bitcoigold-o1b[.]com, and tech@xn--bitcoingld-lcb[.]org. campaigns using idn can be diffcult to recognize as
malicious because they are typically very similar to the mimicked legitimate domains except for a single character (fig. 23).
(see ioc section for more likely related idns)
figure 22: sample email containing a url to malicious idn hosting pyinstaller powerratankba downloader. the
idn email address is emphasized in a red box.
figure 23: excerpt from phishing email showing the idn link
with red arrow pointing to internationalized character
many thanks to yonathan klijnsma (@ydklijnsma) of riskiq,
whose assistance allowed us to analyze a historical scrape of
one of the web pages hosting the malware at xn--bitcoingldlcb[.]org. in the scrape, an additional text and a button were
inserted in place of the btg logo. the button used javascript to
download a payload from hxxps://bitcoing ld[.]org/bitcoingold.
exe (idn: xn--bitcoingld-lcb[.]org) (fig. 24). additional
differences are likely the result of changes to the legitimate
website (fig. 25) since the malicious campaign.
figure 24: malicious btg website hosting
powerratankba downloader. credit: riskiq
figure 25: legitimate btg website showing difference
between legitimate and malicious websites (note: this
screenshot was not taken on the same day as the
screenshot of the malicious website)
once clicked, the button on the malicious btg page would have directed a victim to download a payload
from hxxps://bitcoing ld[.]org/bitcoingold.exe. at the time of our analysis, this url was not returning content.
however, we discovered from a comment on a multiple anti-virus scanning service that someone targeted
by this campaign had uploaded a payload downloaded from the fake website. the fle in that case was
named electrongold- ( ).
we also found a similar payload with unknown origin named electrongold- ( ).
the second campaign we discovered used a fake electrum update as the lure to similarly direct victims to a malicious idn
resembling the legitimate website (fig. 26). the emails in this case were sent, based on our visibility, using a
unique @ email address for each recipient, and at least some of the emails were sent between november 18-21,
2017. a subject of new electrum wallet released was used to trick victims into thinking that they needed to download
an update for electrum to be able to use segwit2x and bitcoin gold. if a victim clicked on the malicious link, they were
presented with what appeared to be a normal version of electrum s offcial website (fig. 27).
figure 26: phishing email with fake electrum
wallet application update announcement
figure 27: a fake website with links to backdoored installation
packages highlighted in red boxes and internationalized
character noted by red arrow
each of the links highlighted in red led to a malicious payload hosted directly on the same server: hxxps://xn--electrms2a[.]org/electrum- (fig. 28). the electrum- is a backdoored pyinstaller that is confgured to download a
vbscript powerratankba downloader.
figure 28: html code from malicious electrum webpage
in both campaigns, the same malicious python code was injected into the pyinstallers, specifcally into \gui\qt\installwizard.
py. the backdoor code in each campaign is nearly identical except for the target url and the fle name to which the
downloaded vbscript is saved (fig. 29).
figure 29: side-by-side comparison of backdoored scripts. left: btg, right: electrum
the btg campaign was confgured to download a vbscript from hxxp://www.btc-gold[.]us/images/top_ while
saving the downloaded script to c:\users\public\documents\diff.vbs. we were unable to retrieve this fle but suspect a
powerratankba variant would have been downloaded based on other campaigns.
the electrum campaign was similarly confgured to download a vbscript; however, in this case we were able to analyze the
downloaded payload. the backdoored downloaded a script from hxxp://trade.publicvm[.]com/images/top_ (see attribution section for more commentary) while saving the downloaded script to c:\users\public\documents\
electrum_backup.vbs. the downloaded electrum_backup.vbs was a powerratankba downloader with a target url of
hxxp://trade.publicvm[.]com/ , which ultimately delivered a powerratankba implant with a c&c of trade.
publicvm[.]com.
implant description and analysis
three key implants were used at various points in these campaigns. the implants -- powerratankba, gh0st rat, and
ratankbapos -- and specifc variations are described in detail below.
powerratankba description
powerratankba is used for the same purpose as ratankba: as a frst stage reconnaissance tool and for the deployment
of further stage implants on targets that are deemed interesting by the actor. similar to its predecessor, powerratankba
utilizes http for its c&c communication.
once executed, powerratankba frst sends detailed information about the infected device to its c&c server via the
baseinfo http post (fig. 30), including the computer name, ip address(es), os boot time and installation date, language,
if ports 139, 3389, and/or 445 are open/closed/fltered, a process list, and ( only) output from two wmic
commands (fig. 31).
figure 30: initial http post containing infected device information to powerratankba.a c&c
figure 31: wmic command output sent via same initial http post
there are only slight variations between the initial baseinfo http post, such as the process list is retrieved by
powerratankba.a using tasklist /svc while uses just tasklist .
powerratankba.a c&c description
after the initial c&c check-in, powerratankba.a issues what http get requests (fig. 32) to retrieve commands from the c&c
server. all powerratankba.a http requests contain a randomly generated numeric uid passed in the u http uri parameter.
figure 32: powerratankba.a what http get request
this variant receives commands and sends responses in plaintext. this variant only has four commands (table 1) including
a sleep, exit, and two different execute code functions.
table 1: powerratankba.a c&c commands
command description
success sleep and send request after sleep
killkill exit
execute download payload from provided url and execute via memory injection
downexec download payload from provided url, save to disk, then execute c&c description
similar to its predecessor, issues what http requests to its c&c server after the initial check-in. instead
of a numeric uid, this variant uses the infected device s double-base64-encoded mac address (fig. 33).
figure 33: what http get request
commands from the c&c are still expected as plaintext but command parameters for all commands except interval are
encrypted with des using casillas as both the key and initialization vector (iv) and then base64-encoded. the response
of the cmd command is the only data that is sent des encrypted to the c&c whilst all other network traffc sent from the
infected device to the c&c is either plaintext or base64-encoded.
several new commands were added to this variant (table 2) while execute and downexec were replaced. the command
exe was eventually changed to inj while functionality remained the same. additionally, some earlier variants did not contain
all of the commands listed below but the overall capabilities of the backdoor remained largely the same, therefore for the
purpose of this research all variants with des encryption are considered variant .
table 2: c&c commands
command description
success sleep and send request after sleep
killkill exit
interval change default sleep length
cmd execute command using /c $cmdinst . command response is sent back to the
c&c des encrypted and base64 encoded
cf_sv replace sch, vbs, ps1 fles with provided server location and pre-determined uri (e.g.,
rrr download payload from provided url, write to , and
then execute payload.
exe or inj download payload from provided url, inject into process memory using invokere ectivepeinjection
powerratankba persistence
for persistence, powerratankba.a saves a js fle to the victim s startup folder as that will
be executed every time the victim s user account logs in. the persistence js (fig. 34) contains a xor
encoded powershell script to retrieve a base64 encoded powershell from a hardcoded url (e.g.,
hxxp://macintosh.linkpc[.]net:8080/ ). the encoded powershell script used a xor key of zwzbgminrqlusvtghwvyanjhtvuhtltugkohiyoxqefeiphngacnkmbwgrtjihraniizjnnzhvf .
figure 34: persistence js is capable of using two different persistence methods while only one will be used based on whether
or not the executing user has administrator privileges. powerratankba frst checks if the account has administrator
privileges by executing the following command: whoami /groups | fndstr /c: s-1-5-32-544 | fndstr /c: enabled group && goto:isadministrator . if the user account does have administrator privileges then powerratankba will download a
powershell script from a hardcoded location (e.g., $baseserver + ), save it to a hardcoded location
(e.g., c:/windows/system32/windowspowershell/v1.0/examples/detail.ps1), and fnally create a scheduled task to execute
the downloaded powershell script on system startup. if the user account does not have administrator privileges then a
vbscript fle is downloaded from a hardcoded location (e.g., $baseserver + images/top_ ) and saved to the
executing user s startup folder as, for example, pwdopt.vbs or proxyserver.vbs. stage2 - gh0st rat
a gh0st remote access trojan/tool (rat) was delivered via to several devices running common
cryptocurrency-related applications. the gh0st rat samples were delivered via the memory injection exe/inj command (fig.
35). after decrypting the command with des the target url was revealed to be hxxp://180.235.133[.]235/img.gif (fig. 36).
figure 35: exe command delivered from c&c to infected device
figure 36 (left): retrieving
base64-encoded gh0st dropper
the fake image was actually a base64-encoded
custom encryptor with the embedded, encrypted
gh0st rat as the fnal payload. the encryptor
utilized aes in cbc-mode with the nist
special publication 800-38a example key of
figure 37: aes key and iv in custom encryptor downloaded by the decrypted gh0st implant is a custom variant with magic bytes of rfc18 (fig. 38). this variant was likely based on version of gh0st/pcrat, however we consider it likely that the author(s) have given their implants an internal version of as can be observed in the decompressed initial check-in to the c&c (as well as hardcoded in the binaries) (fig. 39).
figure 38: magic rfc18 value in unpacked gh0st rat sample
figure 39: version rfc18 gh0st rat
much of the code remains the same, including the usage of zlib compression and the infamous \x78\x9c default
zlib compression header bytes (fig. 40) observed in countless gh0st rat samples over the years.
figure 40: initial gh0st check-in depicting rfc18 magic bytes and zlib header
gh0st rat purpose
during our research we discovered that long-term sandboxing detonations of powerratankba not running cryptocurrencyrelated applications were never infected with a stage2 implant. this may indicate that the powerratankba operator(s)
were only interested in infecting device owners with an obvious interest in various cryptocurrencies. in one case, a rfc18
gh0st rat was delivered to a infected device within twenty minutes of the initial infection. from analyzing
c&c traffc logs we assess that a lazarus operator almost immediately viewed the screen of the infected device and then
proceeded to take over full remote control, giving them the ability to interact with applications on the infected device,
including a password-protected bitcoin wallet application.
shopping spree: enter ratankbapos
beyond stealing millions of us dollars worth of cryptocurrency, we have discovered a lazarus operation to steal pointof-sale (pos) data primarily targeting pos terminals of businesses operating in south korea. considering the time of
year, most retail businesses around the world report their highest volume of sales between november and december so
naturally pos is a popular target for criminals. enter ratankbapos, possibly the frst publicly documented nation-state
sponsored campaign to steal pos data from a pos-related framework.1
at this time we have been unable to determine how ratankbapos is being delivered; however, based on its sharing of
c&c with powerratankba implants we hypothesize that lazarus operators infltrated at least one organization s networks
utilizing powerratankba to deploy later stage implants (including the possibility of rfc18 gh0st rat) to ultimately deploy
ratankbapos. based on the fact that the fle was hosted on the c&c in plaintext, and not base64 encoded, we assess that
ratankbapos was more likely deployed with a later stage implant other than powerratankba.
ratankbapos analysis
ratankbapos is deployed through a process injection dropper that is also capable of installing itself persistently, checking
a c&c for either an update or a command to delete itself, dropping the ratankbapos implant to disk, and fnally searching
for the targeted pos process and module for injection and ultimately the theft of pos data.
the dropper frst sets up persistence by creating a registry key in hkey_local_machine\software\microsoft\windows\
currentversion\run\igfxgpttray. it uses its own module fle name for the registry key value. next, it makes an http request
to a hardcoded url hxxp://www[.]webkingston[.]com/update.jsp?action=need_update using a hardcoded user-agent
(ua) of nimo software http retriever 1.0 (fig. 41) to request either instruction from the c&c to delete itself and remove
the persistence registry key or to download an updated implant with which to replace itself. if no response is returned from
the c&c, ratankbapos will begin the process injection search.
figure 41: ratankbapos dropper requesting and receiving update from c&c
1 we acknowledge the excellent work from @ashley_shen_920, @051r15, and @kjkwak12 with their documentation of north korean-related attacks on vanxatm
which was targeting atm devices and not directly pos.
the process injection search begins by taking a snapshot of the process list using createtoolhelp32snapshot. the implant
dropper/injector will then case-insensitive search for a process named which we assess is likely associated
with tobesoft s xplatform ui/ux design software. if a process name match is found then a th32cs_snapmodule
createtoolhelp32snapshot call is used to make a snapshot of s running module list. loaded modules
are then iterated using module32first and module32next while converting each result to lowercase by adding 0x20 to
any uppercase letters and then fnally comparing the string to (fig. 42) that we assess is associated with
a ksnet pos framework . finally, the flesize of is checked to make sure it is 98,304 bytes (fig. 42). if a
successful match is found then the process id (pid) of is returned. lastly, ratankbapos will be written to
disk as and the pid of process will be used to inject into using
loadlibrarya and createremotethread (fig. 43).
figure 42: dropper/injector searching for and correct flesize
figure 43: injecting ratankbapos into ratankbapos will frst hook the module at offset 0xb146 (fig. 44). interestingly there is code for
ratankbapos to check for an exported function named 1000b146, which seems like an unusual export
name for which to check, but this code will never be used because !strcmp( 1000b146 , 1000b146 ) will always be true.
we hypothesize that this feature was included either by mistake or was previously used for debugging. ratankbapos will
also log messages to a fle stored in .
figure 44: ratankbapos
setting injection offset
at this point in the reverse
engineering process, we
would naturally begin
reversing the ksnetadsl.
dll module; however, we
have only been able to fnd
two such modules with a
after analyzing both modules, our preliminary assessment is that neither of the modules are the correct
target for ratankbapos. we can at least gain some insight into the purpose of , which appears to be the
handling of encrypted and decrypted credit card numbers for a ksnet-related pos framework system (fig. 45). further
analysis of ratankbapos focusing on the code used for c&c revealed the likely purpose of this implant
figure 45: screenshot showing ksnet module interaction with card_no registry key
only one http post request is programmed in ratankbapos for the communication to a c&c that is called via
createthread in the hook handler (doc2, fig. 46).
figure 46: hook handler creating new thread for c&c then hooking our analysis of the c&c communication revealed a number of clues as to what was being exfltrated. initially, the implant
uses strchr to fnd the frst occurrence of = in the string data that is received from the hook of . next,
37-bytes beginning at 16-bytes before the position of the = are copied to a buffer. finally, that buffer is compared to a
substitution buffer that was created at the beginning of ratankbapos execution (fig. 47). the substitution algorithm uses
the values starting at offset 0x30-0x39 in the e -flled buffer to substitute the ascii values of 0-9 for zckoadblnx as
well as at offset 0x3d for substitution of ascii = to y . therefore, values 0-9 will be obfuscated to zckoadblnx while = will be obfuscated to y (fig. 48).
figure 47: obfuscation substitution buffer created in ratankbapos
figure 48: obfuscation substitution buffer in memory
to obfuscate the data, ratankbapos simply uses the hex value of the cleartext ascii string to substitute itself for a value
in the substitution buffer. for instance, a value of 0 would be substituted to z while any equals signs ( = ) will be
substituted for y . this method is used to likely obfuscate the data so it is harder to detect by simply glancing at network
traffc or through the use of heuristic-based detection of plaintext credit card data transmitted over the network. once
the stolen data has been obfuscated, it is sent in a post http request to the url ?action=up using the same
hardcoded ua as the injector: nimo software http retriever 1.0 (fig. 49). so far we have observed the following c&c
domains: www.energydonate[.]com and online-help.serveftp[.]com.
figure 49: doc2 function that obfuscates stolen data and exfltrates to a c&c
based on documentation we have found online,
ratankbapos is possibly targeting plaintext track data in
the frst 16 bytes followed by a = and fnally followed by
encrypted pos-related data beginning with 99 (fig. 50).
according to the document, this is an encrypted form of
the track data. based on this, there is the possibility that
this campaign may be targeting a softcamp pos-related
software application, framework, or device. if we are correct
and the values 99 always follow the = sign then one
could potentially fnd exfltrated data in network traffc by
searching for the string yxx starting at offset 16 in the
client body of an http post request. however, more logic
will likely be necessary to reduce false positives but this
opens up several options for detection.
figure 50: documentation on south korean pos
software depicting pos data that matches the pattern
ratankbapos is searching for (markings not ours)
ratankbapos targeted region
based on the fact that ratankbapos is targeting a south korean software vendor s pos framework, including clues that
the length of exfltrated data matches related pos data (document here, and another document here), we assess with high
confdence that this threat is primarily targeting devices in south korea.
attribution to lazarus group
attribution is a controversial topic and arguably one of the most diffcult tasks threat intelligence analysts face. however,
based on our research, we assess with a high level of confdence given the information available to us that the operations
and activity discussed in this research are attributed to lazarus group and ultimately north korea.
in consideration of the controversial and diffcult task at hand, we are providing an above and beyond summary of just
some of the key pieces and overlaps to validate our assessment. key reasons, discussed in detail below, are encryption,
obfuscation, functionality, code overlap, decoys, and c&c.
encryption
in october 2016 lazarus group pulled off a major operation that allegedly compromised at least 20 banks in poland as
well as banks in other countries around the world. the attacks have been well documented by bae, kaspersky, eset,
trendmicro, and symantec. the attribution of this attack to lazarus (aka, bluenoroff) and ultimately north korea is widely
accepted across the industry. what has not been documented publicly, to our knowledge, are the specifcs behind the
implementation of the spritz encryption cipher utilized in some of the implants surrounding the banking incidents in late
2016 and early 2017.
spritz is self-described as a spongy rc4-like stream cipher that was designed by ronald rivest and jacob schuldt.
multiple implementations of spritz exist on github in languages like c and python. anyone researching lazarus group s
version of spritz will quickly fnd out that neither of the previously mentioned implementations will successfully decrypt
hidden payloads in either banking related implants nor powerspritz s legitimate installer payload and malicious
powershell commands.
the issue, or possibly feature, in lazarus group s implementation of spritz can be found buried in a single paragraph on
page fve of the original spritz publication (fig. 51). it states that addition and subtraction may be substituted for exclusiveor (xor) and is referred to spritz-xor.
figure 51: excerpt from spritz publication
examining lazarus group s implementation of spritz in
one of the original implants utilized to compromise banks
in late 2016 and 2017 via watering hole attacks, it quickly
becomes apparent that they have actually implemented
spritz-xor instead of the normal spritz algorithm (fig. 52).
figure 52: spritz-xor decrypt implementation in lazarus group s implant from compromised banks
powerspritz utilizes the same exact spritz-xor implementation as the older lazarus group-attributed implant (fig. 53).
we assess that due to how rare spritz usage is itw, in addition to the implemented deviation from the standard, that it is
unlikely a different threat actor is also using this specifc implementation.
figure 53: spritz-xor decrypt implementation in powerspritz
obfuscation
earlier this year several watering hole attacks targeting south korea utilized an activex 0day exploit in m2soft to deliver
lazarus-connected fbi-rat and charon implants. some of the techniques observed in these attacks overlap with the
js downloader and chm powerratankba campaigns. one such overlap was through the usage of a well-known js
obfuscation technique in both the m2soft exploit and powerratankba js downloader campaigns. the method is a public
and widely used technique of masking strings using their hexadecimal values and placing them in an array assigned to a
variable with a naming structure of _0x[a-f0-9]{4} (fig. 54).
figure 54: activex m2soft exploit utilizing js obfuscation also observed in a powerratankba campaign
functionality
several features in the original ratankba implants are similar or identical when compared to powerratankba and
ratankbapos. furthermore, the usage of a common directory c:\windows\temp\ for the storage of implants and logs are
seen across a wide array of lazarus group s toolset. a brief overview of similar features is shown in below (table 3) while a
detailed description of each overlap may be found below.
table 3: feature comparison table
feature ratankba powerratankba ratankbapos m2soft exploit feib spreader
first consider the c&c protocols utilized in all ratankba, powerratankba, and ratankbapos. ratankba s initial post to
c&c to divulge compromised system information uses the same baseinfo parameter as powerratankba. additionally, a
ratankba sample ( ) utilizes a c&c of while ratankbapos utilizes an identical urifle name for allegedly exfltrating credit card information to a c&c. second,
ratankba s supported commands include success and killkill that function identically to the respective powerratankba
commands. furthermore, a sleep loop of 900 seconds (15 minutes) is utilized in both ratankba and ratankbapos dropper (fig. 56,56).
lastly, while further analyzing the m2soft exploit discussed in the obfuscation section, a familiar destination directory of. this destination directory was also used during the
powerratankba chm campaign, by ratankbapos for log and implant storage, and by the feib spreader.
figure 57: deobfuscated m2soft exploit used to deliver lazarus fbi-rat implant
figure 58: deobfuscated m2soft exploit used to deliver lazarus charon implant
code overlap
on or before october 3rd, 2017, the far eastern international bank (feib) in taiwan was
hacked by lazarus group to steal money via the swift system. one of the implants utilized in that attack was a loader and
spreader that writes itself to the windows temp directory: c:\windows\temp\. this directory is also used by numerous other
lazarus group implants including by the ratankbapos dropper for the payload drop location as well as for ratankbapos
logging. additionally, there are several instances of code overlap between ratankbapos and the feib spreader implant.
one such overlap includes the way in which each implant sets up persistence in almost precisely the same way (fig. 59).
figure 59: registry key persistence. left: feib spreader, right: ratankbapos dropper
decoys
content found in a powerratankba js downloader decoy ( downloaded by ) was previously
utilized in lazarus campaigns using techniques that have more traditionally, to our knowledge, been used for espionage
rather than for fnancial gain. the campaign occurred on august 4th, 2017, where lazarus group impersonated a national
police offcer of south korea along with a malicious microsoft offce excel document. the malicious excel attachment
utilized a macro-based vbscript xor dropper technique that has been very well documented in public already.
the document used in this attack was named .xls
, which roughly translates to bitcoin
transaction history. using the macro-based vbscript xor dropper technique a coredn downloader implant is dropped to
disk with a c&c of www.unsunozo[.]org. the interesting overlap with the powerratankba campaigns can be found in the
lure used by the excel spreadsheet (fig. 60). the highlighted transactions, after the final bitcoin address section match
with the beginning of the transactions used in the powerratankba decoy .
figure 60: excel coredn ~ decoy on the left, powerratankba decoy on the right
on a fnal note for this aspect of the actor attribution, campaigns utilizing the vbscript xor macro technique have
historically been used for attacks more closely associated with espionage than for direct fnancial gain, as was the case
when several campaigns targeted the personal accounts of employees at us defense contractors. this behavior may offer
a clue as to the desperation north korea has for procuring currency through illicit means, possibly due to the economic
sanctions imposed on the regime. this may indicate that there has been a signifcant shift in directives for the lazarus
team(s) that historically conducted espionage campaigns. furthermore, several of the campaigns utilizing the old vbscript
xor macro technique have direct or within-one-week overlap with powerratankba campaigns alluding to the possibility
that there is in fact more than one team working under the north korean umbrella as other companies have suggested
(e.g., kaspersky s excellent write-up on bluenoroff).
c&c
a report was found in a facebook post from mickeyfntech that listed a domain
utilized in several powerratankba campaigns as being associated with infrastructure
utilized in the breach of the feib (fig. 61). the domain, trade.publicvm[.]com,
was allegedly connected to the feib hack. that domain was also used by several
powerratankba downloaders and payloads for hosting as well as c&c. this is a low
confdence indicator as we have been unable to corroborate if that domain was in
fact utilized by lazarus in the hacking of the feib.
figure 61: facebook post listing powerratankba domain as being associated
with feib breach
conclusion
this report has introduced several new additions to lazarus group s ever-growing arsenal, including a variety of different
attack vectors, a new powershell implant and gh0st rat variant, as well as an emerging point-of-sale threat targeting
south korean devices. in addition to insight into lazarus emerging toolset, there are two key takeaways from this research: analyzing a fnancially motivated arm of a state actor highlights an often overlooked or underestimated aspect of statesponsored attacks; in this case, we were able to differentiate the actions of the fnancially motivated team within lazarus
from those of their espionage and disruption teams that have recently grabbed headlines. this group now appears to be targeting individuals rather than just organizations: individuals are softer targets, often
lacking resources and knowledge to defend themselves and providing new avenues of monetization for a statesponsored threat actor s toolkit. moreover, both the explosive growth in cryptocurrency values and the emergence of new point-of-sale malware near the
peak holiday shopping season provide an interesting example of how one state-sponsored actor is following the money,
adding direct theft from individuals and organizations to the more traditional approach of targeting fnancial institutions
for espionage that we often observe with other apt actors.
