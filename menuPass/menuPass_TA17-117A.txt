overview
the national cybersecurity and communications integration center (nccic) has become aware of an emerging sophisticated campaign, occurring since at least may 2016, that uses multiple malware implants. initial victims have been identified in several sectors, including information technology, energy, healthcare and public health, communications, and critical manufacturing. according to preliminary analysis, threat actors appear to be leveraging stolen administrative credentials (local and domain) and certificates, along with placing sophisticated malware implants on critical systems. some of the campaign victims have been it service providers, where credential compromises could potentially be leveraged to access customer environments. depending on the defensive mitigations in place, the threat actor could possibly gain full access to networks and data in a way that appears legitimate to existing monitoring tools. although this activity is still under investigation, nccic is sharing this information to provide organizations information for the detection of potential compromises within their organizations. nccic will update this document as information becomes available. for a downloadable copy of this report and listings of iocs, see: to report activity related to this incident report alert, please contact nccic at ncciccustomerservice@ or 1-888-282-0870. description
risk evaluation
nccic cyber incident scoring system (nciss) rating priority level (color) a medium priority incident may affect public health or safety, national security, economic security, foreign relations, civil liberties, or public confidence. details
while nccic continues to work with a variety of victims across different sectors, the adversaries in this campaign continue to affect several it service providers. to achieve operational efficiencies and effectiveness, many it service providers often leverage common core infrastructure that should be logically isolated to support multiple clients. intrusions into these providers create opportunities for the adversary to leverage stolen credentials to access customer environments within the provider network. technical analysis
the threat actors in this campaign have been observed employing a variety of tactics, techniques, and procedures (ttps). the actors use malware implants to acquire legitimate credentials then leverage those credentials to pivot throughout the local environment. nccic is aware of several compromises involving the exploitation of system administrators credentials to access trusted domains as well as the malicious use of certificates. additionally, the adversary makes heavy use of powershell and the open source powersploit tool to enable assessment, reconnaissance, and lateral movement. command and control (c2) primarily occurs using rc4 cipher communications over port 443 to domains that change ip addresses. many of these domains spoof legitimate sites and content, with a particular focus on spoofing windows update sites. most of the known domains leverage dynamic dns services, and this pattern adds to the complexity of tracking this activity. listings of observed domains are found in this document s associated stix package and .xlsx file. the indicators should be used to observe potential malicious activity on your network. user impersonation via compromised credentials is the primary mechanism used by the adversary. however, a secondary technique to maintain persistence and provide additional access into the victim network is the use of malware implants left behind on key relay and staging machines. in some instances, the malware has only been found within memory with no on-disk evidence available for examination. to date, the actors have deployed multiple malware families and variants, some of which are currently not detected by anti-virus signatures. the observed malware includes plugx/sogu and redleaves. although the observed malware is based on existing malware code, the actors have modified it to improve effectiveness and avoid detection by existing signatures. both redleaves and plugx have been observed being executed on systems via dynamic-link library (dll) side-loading. the dll side-loading technique utilized by these malware families typically involves three files: a non-malicious executable, a malicious dll loader, and an encoded payload file. the malicious dll is named as one of the dlls that the executable would normally load and is responsible for decoding and executing the payload into memory. redleaves malware
the most unique implant observed in this campaign is the redleaves malware. the redleaves implant consists of three parts: an executable, a loader, and the implant shellcode. the redleaves implant is a remote administration trojan (rat) that is built in visual c++ and makes heavy use of thread generation during its execution. the implant contains a number of functions typical of rats, including system enumeration and creating a remote shell back to the c2. capabilities
system enumeration. the implant is capable of enumerating the following information about the victim system and passing it back to the c2: system name,
system architecture (x86 or x64),
operating system major and minor versions,
amount of available memory,
processor specifications,
language of the user,
privileges of the current process,
group permissions of the current user,
system uptime,
ip address, and
primary drive storage utilization.
command execution. the implant can execute a command directly inside a command shell using native windows functionality by passing the command to run to with the /c option ( /c <command> ). command window generation. the implant can also execute commands via a remote shell that is generated and passed through a named pipe. a command window is piped back to the c2 over the network as a remote shell or alternatively to another process or thread that can communicate with that pipe. the implant uses the mutexredleavescmdsimulatormutex. file system enumeration. the implant has the ability to enumerate data within a specified directory, where it gathers filenames, last file write times, and file sizes. network traffic compression and encryption. the implant uses a form of lzo compression to compress data that is sent to its c2. after compression, the data for this implant sample is then rc4-ciphered with the key 0x6a6f686e3132333400 (this corresponds to the string john1234 with the null byte appended). network communications redleaves connects to the c2 over tcp port 443, but does not use the secure flag when calling the api function internetopenurlw. the data is not encrypted and there is no ssl handshake as would normally occur with port 443 traffic, but rather the data is transmitted in the form that is generated by the rc4 cipher. current redleaves samples that have been examined have a hard-coded c2. inside the implant s configuration block in memory were the strings in table 1. table 1: redleaves sample strings found in c2 qn4869md mutex used to determine if the implant is already running (varies from sample to sample) 2016-5-1-inco unknown % - process that the implant was injected into john1234 (with the null byte afterward) rc4 key while the name of the initial mutex, qn4869md in this sample, varies among redleaves samples, the redleavescmdsimulatormutex mutex name appears to be consistent. table 2 contains a sample of the implant communications to the domain windowsupdates.dnset[.]com over tcp port 443. table 2: redleaves sample beacon redleaves network traffic has two 12-byte fixed-length headers in front of each rc4-encrypted compressed payload. the first header comes in its own packet, with the second header and the payload following in a separate packet within the same tcp stream. the last four bytes of the first header contain the number of the remaining bytes in little-endian format (0x88 in the sample beacon above). the second header, starting at position 0x0c, is xor d with the first four bytes of the key that is used to encrypt the payload. in the case of this sample, those first four bytes would be john (or 0x6a6f686e using the ascii hex codes). after the xor operation, the bytes in positions 0x0c through 0x0f contain the length of the decrypted and decompressed payload. the bytes in positions 0x10 through 0x13 contain the length of the encrypted and compressed payload. to demonstrate, in the sample beacon, the second header follows: the length of the decrypted and decompressed payload is 0x7e000000 in little-endian format (0x146f686e xor 0x6a6f686e). the length of the encrypted and compressed payload is 0x7c000000 in little-endian (0x166f686e xor 0x6a6f686e). this is verified by referring back to the sample beacon which had the number of remaining bytes set to 0x88 and subtracting the length of the second header (0x88 0xc = 0x7c). strings
note: use caution when searching based on strings, as common strings may cause a large number of false positives. all three of these files must be present for execution of the malware to succeed. when all files are present and the file is executed, it will make calls to the following dll exports within the file: vlc_version checks to see if its calling file is named . if the calling file is named something else, execution will terminate and no shellcode will be loaded.
vlc_create reads in the contents of the file mtcreport.ktc.
vlc_init takes in the offset in which the encoded shellcode/implant file is located and deobfuscates it. after deobfuscation, this export executes the shellcode.
vlc_destroy does nothing other than perform a return 0.
vlc_addintf and vlc_cleanup simply call the export vlc_destroy, which returns 0.
when the decodes the shellcode/implant, it calls the shellcode at the beginning of the data blob in memory. the shellcode then activates a new instance of and suspends it. it then makes a call to writeprocessmemory() and inserts the implant with the damaged mz and pe headers into its memory space. it then resumes execution of , which runs the implant. the resulting decoded shellcode with the implant file below it can have a variable md5 based on how it is dumped from memory. the md5 checksums of two instances of decoded shellcode are: during execution, the file will create two mutexes called redleavescmdsimulatormutex and qn4869md. it checks the qn4869md mutex to see if it is already running. it will then perform initial enumeration of the system to include operating system versions, number of processors, ram, and cpu information. plugx
plugx is a sophisticated remote access tool (rat) operating since approximately 2012. although there are now many variants of this rat in existence today, there are still characteristics common to most variants. typically, plugx uses three components to install itself. a non-malicious executable
a malicious dll/installer
an encoded payload the plugx rat.
a non-malicious executable with one or more imports is used to start the installation process. the executable will likely exist in a directory not normally associated with its use. in some cases, the actor may use an executable signed with a valid certificate, and rename the dll and encoded payload with file names that suggest they are related to the trusted file. importantly, the actor seems to vary the encoding scheme used to protect the encoded payload to stifle techniques used by av vendors to develop patterns to detect it. the payload is either encoded with a single byte or encrypted and decompressed. recently, nccic has observed a case where the encoded payload contains a decoding stub within itself, beginning at byte zero. the malware simply reads this payload and executes it starting at byte zero. the stub then decodes and executes the rest of itself in memory. notably, this stub varies in its structure and algorithm, again stifling detection by signature based security software. the plugx malware is never stored on disk in an unencrypted or decoded format. when the initial executable is launched, the imported library, usually a separate dll, is replaced with a malicious version that in turn decodes and installs the third and final component, which is the plugx rat itself. typically, the plugx component is obfuscated and contains no visible executable code until it is unpacked in memory, protecting it from av/yara scans while static. during the evolution of these plugx compromises, nccic noted an increasing implementation of protections of the actual decoded plugx in memory. for example, the most recent version we looked at implements a secure strings method, which hides the majority of the common commands used by plugx. this is an additional feature designed to thwart signature based security tools. once the plugx rat is installed on the victim, the actors has complete c2 capabilities of the victim system, including the ability to take screenshots and download files from the compromised system. the communications between the rat (installed on the victim system) and the plugx c2 server are encoded to secure the communication and stifle detection by signature based network signature tools. the advanced capabilities of plugx are implemented via a plugin framework. each plugin operates independently in its own unique thread within the service. the modules may vary based on variants. table 5 lists the modules and capabilities contained within one sample recently analyzed by nccic. table 5: modules and capabilities of plugx module name capability disk wide range of system-related capabilities including file / directory / drive enumeration, file / directory creation, create process, and obtain environment variables keylog logs keystrokes and saves data to log file nethood enumerates the host's network resources via the windows multiple provider router dll netstat set the state of a tcp connection or obtain the extended tcp or udp tables (lists of network endpoints available to a process) of each active process on the host option provides the ability to initiate a system shutdown, adjust shutdown-related privileges for a given process, and lock the user's workstation portmap port mapping process process enumeration, termination, and capability to obtain more in-depth information pertaining to each process (e.g. companyname, filedescription, fileversion of each module loaded by the process) regedit create, read, update & delete registry entries screen capability to capture screenshots of the system service start, stop, remove, configure & query services shell remote shell access sql enumerate sql databases and available drivers; execute sql queries telnet provides a telnet interface the plugx operator may dynamically add, remove, or update plugx plugins during runtime. this provides the ability to dynamically adjust c2 capabilities based on the requirements of the c2 operator. network activity is often seen as post requests similar to that shown in table 6. network defenders can look to detect non-ssl http traffic on port 443, which can be indicative of malware traffic. the plugx malware is also seen using tcp ports 80, 8080, and 53. even though the beacon went to port 443, which is commonly used for encrypted http communications, this traffic was plaintext http, as is common for this variant of plugx. for it service providers
all organizations that provide it services as a commodity for other organizations should evaluate their infrastructure to determine if related activity has taken place. active monitoring of network traffic for the indicators of compromise (iocs) provided in this report, as well as behavior analysis for similar activity, should be conducted to identify c2 traffic. in addition, frequency analysis should be conducted at the lowest level possible to determine any unusual fluctuation in bandwidth indicative of a potential data exfiltration. both management and client systems should be evaluated for host indicators provided. if an intrusion is suspected, please reach out to the nccic at the contact information provided at the end of this report. for private organizations and government agencies
all organizations should include the iocs provided in their normal intrusion detection systems for continual analysis. organizations that determine their risk to be elevated due to alignment to the sectors being targeted, unusual detected activity, or other factors, should conduct a dedicated investigation to identify any related activity. organizations which leverage external it service providers should validate with their providers that due diligence is being conducted to validate if there are security concerns with their specific provider. if an intrusion is suspected, please reach out to the nccic at the contact information provided at the end of this report. detection
nccic is providing a compilation of iocs from a variety of sources to aid in the detection of this malware. the iocs provided in the associated stix package and .xlsx file were derived from various government, commercial, and publically available sources. the sources provided does not constitute an exhaustive list and the u.s. government does not endorse or support any particular product or vendor s information listed in this report. however, nccic includes this compilation here to ensure the distribution of the most comprehensive information. this alert will be updated as additional details become available. other detection methods
examine port/protocol mismatches: examine network traffic where the network port and protocol do not match, such as plaintext http over port 443. administrative share mapping: when a malicious actor tries to move laterally on a network, one of the techniques is to mount administrative shares to perform operations like uploading and downloading resources or executing commands. in addition, tools like system internals psexec will mount the shares automatically for the user. since administrators may map administrative shares legitimately while managing components of the network, this must be taken into account. filter network traffic for smb mapping events and group the events by source ip, destination ip, the mounted path (providing a count of total mounts to that path), the first map time, and the last map time
collect windows event logs event id 5140 (network share object was accessed) can be used to track c$ and admin$ mounts by searching the share name field
vpn user authentication mismatch: a vpn user authentication match occurs when a user account authenticates to an ip address but once connected the internal ip address requests authentication tokens for other users. this may create false positives for legitimate network administrators but if this is detected, organizations should verify that the administrative accounts were legitimately used. vpn activity from vps providers: while this may also produce false positives, vpn logins from virtual private server (vps) providers may be an indicator of vpn users attempting to hide their source ip and should be investigated. impact
a successful network intrusion can have severe impacts, particularly if the compromise becomes public and sensitive information is exposed. possible impacts include: temporary or permanent loss of sensitive or proprietary information,
disruption to regular operations,
financial losses incurred to restore systems and files, and
potential harm to an organization s reputation.
solution
properly implemented defensive techniques and programs make it more difficult for an adversary to gain access to a network and remain persistent yet undetected. when an effective defensive program is in place, actors should encounter complex defensive barriers. actor activity should also trigger detection and prevention mechanisms that enable organizations to contain and respond to the intrusion more rapidly. there is no single or set of defensive techniques or programs that will completely avert all malicious activities. multiple defensive techniques and programs should be adopted and implemented in a layered approach to provide a complex barrier to entry, increase the likelihood of detection, and decrease the likelihood of a successful compromise. this layered mitigation approach is known as defense-in-depth. nccic mitigations and recommendations are based on observations made during the hunt, analysis, and network monitoring for threat actor activity, combined with client interaction. whitelisting
enable application directory whitelisting through microsoft software restriction policy (srp) or applocker;
use directory whitelisting rather than trying to list every possible permutation of applications in an environment. safe defaults allow applications to run from programfiles, programfiles(x86), and system32. all other locations should be disallowed unless an exception is granted.
prevent the execution of unauthorized software by using application whitelisting as part of the security hardening of operating systems insulating.
enable application directory whitelisting via the microsoft srp or applocker.
account control
decrease a threat actor s ability to access key network resources by implementing the principle of least privilege.
limit the ability of a local administrator account to login from a local interactive session (e.g., deny access to this computer from the network ) and prevent access via a remote desktop protocol session.
remove unnecessary accounts, groups, and restrict root access.
control and limit local administration.
make use of the protected users active directory group in windows domains to further secure privileged user accounts against pass-the-hash compromises.
workstation management
create a secure system baseline image and deploy to all workstations.
mitigate potential exploitation by threat actors by following a normal patching cycle for all operating systems, applications, software, and all third-party software.
apply asset and patch management processes.
reduce the number of cached credentials to one if a laptop, or zero if a desktop or fixed asset.
host-based intrusion detection
configure and monitor system logs through host-based intrusion detection system (hids) and firewall.
deploy an anti-malware solution to prevent spyware, adware, and malware as part of the operating system security baseline.
monitor antivirus scan results on a regular basis.
server management
create a secure system baseline image, and deploy to all servers.
upgrade or decommission end-of-life non windows servers.
upgrade or decommission servers running windows server 2003 and older versions.
implement asset and patch management processes.
audit for and disable unnecessary services.
server configuration and logging
establish remote server logging and retention.
reduce the number of cached credentials to zero.
configure and monitor system logs via a centralized security information and event management (siem) appliance.
add an explicit deny for %userprofile% .
restrict egress web traffic from servers.
in windows environments, utilize restricted admin mode or remote credential guard to further secure remote desktop sessions against pass-the-hash compromises.
restrict anonymous shares.
limit remote access by only using jump servers for such access.
change control
create a change control process for all implemented changes.
network security
an intrusion detection system (ids) should:
implement continuous monitoring.
send alerts to a siem tool.
monitor internal activity (this tool may use the same tap points as the netflow generation tools).
netflow capture should:
set a minimum retention period of 180 days.
capture netflow on all ingress and egress points of network segments, not just at the managed trusted internet protocol services (mtips) or trusted internet connections (tic) locations.
network packet capture (pcap):
retain pcap data for a minimum of 24 hours.
capture traffic on all ingress and egress points of the network.
use a virtual private network (vpn):
maintain site-to-site vpn with customers.
authenticate users utilizing site-to-site vpns through adaptive security appliance (asa).
use authentication, authorization, and accounting (aaa) for controlling network access.
require personal identity verification (piv) authentication to an https page on the asa in order to control access. authentication should also require explicit rostering of piv distinguished names (dns) that are permitted to enhance the security posture on both networks participating in the site-to-site vpn.
establish appropriate secure tunneling protocol and encryption.
strengthen router configuration (e.g., avoid enabling remote management over the internet and using default ip ranges; automatically logout after configuring routers; use encryption).
turn off wi-fi protected setup (wps), enforce the use of strong passwords, keep router firmware up-to-date; and
improve firewall security (e.g., enable auto updates, revise firewall rules as appropriate, implement whitelists, establish packet filtering, enforce the use of strong passwords, and encrypt networks).
conduct regular vulnerability scans of the internal and external networks and hosted content to identify and mitigate vulnerabilities.
define areas within the network that should be segmented to increase visibility of lateral movement by an adversary and increase the defense in-depth posture.
develop a process to block traffic to ip addresses and domain names that have been identified as being used to aid previous malicious activities.
network infrastructure recommendations
ensure you are following national security agency (nsa) network device integrity (ndi) best practices.
ensure your networking equipment has the latest available operating system and patches.
host recommendations
implement policies to block workstations-to-workstation remote desktop protocol (rdp) connections through group policy object (gpo) on windows, or a similar mechanism.
store system logs of mission critical systems for at least one year within a siem.
review the configuration of application logs to verify fields being recorded will contribute to an incident response investigation.
users management
immediately set the password policy to require complex passwords for all users (minimum of 15 characters); this new requirement should be enforced as user passwords expire.
reduce the number of domain and enterprise administrator accounts.
create non-privileged accounts for privileged users and ensure they use the non-privileged account for all non-privileged access (e.g., web browsing, email access);
if possible, use technical methods to detect or prevent browsing by privileged accounts (authentication to web proxies would enable blocking of domain administrators).
use two-factor authentication (e.g., security tokens for remote access and to any sensitive data repositories);
if soft tokens are used, they should not exist on the same device that is requesting remote access (laptop), and instead should be on a telephone or other out-of-band device.
create privileged role tracking;
create a change control process to all privilege escalations and role changes on user accounts;
enable alerts on privilege escalations and role changes; and
log privileged user changes in the environment and alert on unusual events.
establish least privilege controls; and
implement a security-awareness training program.
best practices
implement a vulnerability assessment and remediation program.
encrypt all sensitive data in transit and at rest.
create an insider threat program.
assign additional personnel to review logging and alerting data.
complete independent security (not compliance) audit.
create an information sharing program.
complete and maintain network and system documentation to aid in timely incident response, including:
network diagrams,
asset owners,
type of asset, and
an up-to-date incident response plan.
references
paloaltonetworks: menupass returns with new malware and new attacks against japanese academics and organizations fireeye: apt10 (menupass team) renews operations focused on nordic private industry; operations extend to global partners . feb
cylance: the deception project: a new japanese-centric threat pwc/bae systems: operation cloud hopper: exposing a systematic hacking operation with an unprecedented web of global victims: a
jpcert/cc: redleaves-malware based on open source rat ncc group: redleaves implant-overview national cyber security centre: infrastructure update version 1.0" reference: march 17, 2017 fireeye: bugjuice malware profile . april 05, 2017 11:45:00 am, 17-00003261, version: 1
jpcert/cc: chches- malware that communicates with c&c servers using cookie headers revisions
april 27, 2017: initial post
april 28, 2017: updated guidance under the sub-section: network infrastructure recommendations
may 2, 2017: in table 11, fixed trailing quote on date
may 11, 2017: stix and xlsx package was updated