xagentosx: sofacy s xagent macos tool
during our continued research on sofacy s komplex trojan, we have found a sample of a backdoor trojan that we believe the sofacy group uses when targeting individuals running macos systems. the backdoor trojan authors have called it xagentosx, which shares the name xagent with one of sofacy s windows-based trojan and references apple s previous name for macos, os x. it appears the same actor developed both the komplex and xagentosx tools, based on similarities within the following project paths found within the tools:
komplex: /users/kazak/desktop/project/komplex
xagent osx: /users/kazak/desktop/project/xagentosx
we believe it is possible that sofacy uses komplex to download and install the xagentosx tool to use its expanded command set on the compromised system.
xagent c2 communications
the macos variant of xagent has ability to receive commands from threat actors via its command and control channel, but is also capable of logging key strokes via its keylogger functionality. xagent uses http requests to communicate with its c2 servers, which allows the threat actor to interact with the compromised system. the trojan uses http post requests, as seen in figure 1 to send data to the c2 server, and get requests to receive commands from the server, as seen in figure 2. we are still analyzing this trojan to determine the specific structure of the data sent between the trojan and the c2 server; however, it does appear that the trojan is using the rc4 algorithm to encrypt data sent to the c2 server within http post requests. the xagent osx trojan generates a system specific value that it refers to as an agent_id , which is a unique identifier for each compromised host. the value is derived using the ioservice to access the ioplatformuuid property, which is equivalent to the hardware uuid listed in the system information application, as seen in the figure 3 screenshot of our analysis system. the trojan uses the first four bytes of this hardware id as a unique identifier for the system, which in our case was 0000 . figure 3 hardware id used by xagent to uniquely identify compromised hosts
when generating the urls within the http post and get requests, xagent sets one http parameter using a specific data structure that contains this agent_id value. this parameter transmits the agent_id to the c2 server to obtain commands the actor wishes to execute on the compromised system. the data structure used to transmit the agent_id to the c2 is as follows:
the constant value in the data structure is a 7 byte string that is hardcoded to \x56\x0e\x9f\xf0\xeb\x98\x43 , followed by the agent_id value ( 0000 in our case). the first dword in the data is a random value that the trojan will use as an xor key to encrypt the constant value and the agent_id. for instance, the following 15 bytes were used to generate an http parameter during our analysis:
the resulting ciphertext is then encoded using xagent s base64 encoding routine that starts by building the following encoding alphabet:
abcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyz0123456789-_
as you can see, this is not the standard base64 alphabet, rather it is the url and filename safe base 64 alphabet from rfc 4648, as the + in the standard alphabet is replaced with - and the / replaced with _ . it then uses the base64 encoding function with this alphabet to encode the data, which in the above case resulted in:
d-7ig1ngv3pkdouzp974
the trojan then creates a string of 9 random symbols and appends the encoded ciphertext to this random string. for example, the following string would be included in one of the http parameters sent to the c2 server:
ermavsr90d-7ig1ngv3pkdouzp974
in this specific case, the actor made a mistake when configuring this xagent sample with its c2 locations. the sample creates an array that contains the following strings for the trojan to use as c2 locations:
notice the last one is missing the trailing / , which causes an issue when the trojan attempts to use this string to build the remainder of the c2 url, as the trojan will append the next string in the url directly to this string. for instance, when using this string we observed dns queries for apple-search.infoclose , as the string close was supposed to be the next portion of the c2 url.
available commands
the xagent c2 server will provide commands for the trojan to run on the compromised system within its response to inbound http request. the xagentosx trojan includes responses to commands within html tags, which we believe allows the c2 server to format logs for viewing.
in most cases, the responses sent to the c2 server are included between the <font size=4 color=000066><pre> and </pre></font> html tags. we analyzed the command handler and found that it provided the necessary commands for a fully functional backdoor, as seen in table 1. the command handler obtains a command identifier from the c2 server and adds 0xffffff9b to this value and then uses a switch statement to determine the appropriate command to execute. the switch statement checks for 19 cases, suggesting that the command identifier values range between 100 and 118.
he showbackupiosfolder command is rather interesting, as it allows the threat actors to determine if a compromised system was used to backup an ios device, such as an iphone or ipad. we believe this command is used to determine if a mobile device was backed up, and we speculate that the actors would use other commands within xagent to exfiltrate those files.
keylogging functionality
xagent also has a keylogger functionality that allows the threat actors to steal credentials as the user types them. xagent logs key strokes by calling the cgeventtapcreate function to set an event hook to call a callback function named _mycgeventtapcallback when it detects pressed keys. this callback function will call a function named pressedkeywithkeycode, which is responsible for logging the keystrokes. the keylogger will monitor for active application windows and write them to the log in the following format:
when we analyzed this sample, the domain names that were used as backup c2 locations were not registered; therefore, these domains did not provide any links to additional infrastructure. we were also unable to find any additional infrastructure based on the primary c2 location of 23.227.196[.]215. however, according to crowdstrike, the nearby ip address 23.227.196[.]217 hosted the c2 location for an xtunnel payload used by the sofacy group in the attack on the democratic national committee. while these ip addresses do not directly overlap, it does appear that the sofacy group continues to use the same hosting services to host their infrastructure.
conclusion
the sofacy group continues to bolster their toolset to carry out attack campaigns on multiple platforms. in this case, the threat group uses the same name xagent for this macos-based tool as one of their windows-based tools. also, the macos variant of this tool uses a similar network communications method as its windows counterpart, which suggests this group continues to use consolidated c2 services to control compromised hosts, as we saw during our comparison of the komplex and seduploader (formerly referred to as sofacy carberp) tools. also, while we lack attack telemetry, we were able to find a loose connection to the attack campaign that sofacy waged on the democratic national committee based on hosting data in both attacks.
palo alto networks customers are protected from xagentosx via: known samples are detected as malicious by wildfire
all known c2 locations are marked as malicious in pandb
users can use autofocus tag xagent to track this threat known samples are detected as malicious by wildfire
all known c2 locations are marked as malicious in pandb
users can use autofocus tag xagent to track this threat
