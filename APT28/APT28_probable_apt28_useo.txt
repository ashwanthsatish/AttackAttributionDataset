operation russiandoll: adobe & windows zero-day exploits likely leveraged by russia s apt28 in highly-targeted attack
april 18, 2015 | by fireeye labs
fireeye labs recently detected a limited apt campaign exploiting zero-day vulnerabilities in adobe flash and a brand-new one in microsoft windows. using the dynamic threat intelligence cloud (dti), fireeye researchers detected a pattern of attacks beginning on april 13th, 2015. adobe independently patched the vulnerability (cve-2015-3043) in apsb15-06. through correlation of technical indicators and command and control infrastructure, fireeye assess that apt28 is probably responsible for this activity. microsoft is aware of the outstanding local privilege escalation vulnerability in windows (cve-2015-1701). while there is not yet a patch available for the windows vulnerability, updating adobe flash to the latest version will render this in-the-wild exploit innocuous. we have only seen cve-2015-1701 in use in conjunction with the adobe flash exploit for cve-2015-3043. the microsoft security team is working on a fix for cve-2015-1701. exploit overview
the high level flow of the exploit is as follows: 1. user clicks link to attacker controlled website
2. html/js launcher page serves flash exploit
3. flash exploit triggers cve-2015-3043, executes shellcode
4. shellcode downloads and runs executable payload
5. executable payload exploits local privilege escalation (cve-2015-1701) to steal system token the flash exploit is served from unobfuscated html/js. the launcher page picks one of two flash files to deliver depending upon the target s platform (windows 32 versus 64bits). the flash exploit is mostly unobfuscated with only some light variable name mangling. the attackers relied heavily on the cve-2014-0515 metasploit module, which is well documented. it is ropless, and instead constructs a fake vtable for a filereference object that is modified for each call to a windows api. the payload exploits a local privilege escalation vulnerability in the windows kernel if it detects that it is running with limited privileges. it uses the vulnerability to run code from userspace in the context of the kernel, which modifies the attacker s process token to have the same privileges as that of the system process. cve-2015-3043 exploit
the primary difference between the cve-2014-0515 metasploit module and this exploit is, obviously, the vulnerability. cve-2014-0515 exploits a vulnerability in flash s shader processing, whereas cve-2015-3043 exploits a vulnerability in flash s flv processing. the culprit flv file is embedded within as3 in two chunks, and is reassembled at runtime. vulnerability
a buffer overflow vulnerability exists in adobe flash player (<= ) when parsing malformed flv objects. attackers exploiting the vulnerability can corrupt memory and gain remote code execution. in the exploit, the attacker embeds the flv object directly in the actionscript code, and plays the video using netstream class. in memory, it looks like the following:
as the previous picture demonstrated, the followed vector object s length field being overflowed as 0x80007fff, which enables the attacker to read/write arbitrary data within user space. shellcode
shellcode is passed to the exploit from html in flashvars. the shellcode downloads the next stage payload, which is an executable passed in plaintext, to the temp directory with urldownloadtofilea, which it then runs with winexec. payload & c2
this exploit delivers a malware variant that shares characteristics with the apt28 backdoors chopstick and coreshell malware families, both described in our apt28 whitepaper. the malware uses an rc4 encryption key that was previously used by the chopstick backdoor. and the c2 messages include a checksum algorithm that resembles those used in chopstick backdoor communications. in addition, the network beacon traffic for the new malware resembles those used by the coreshell backdoor. like coreshell, one of the beacons includes a process listing from the victim host. and like coreshell, the new malware attempts to download a second-stage executable. one of the c2 locations for the new payload, 87.236.215[.]246, also hosts a suspected apt28 domain ssl-icloud[.]com. the same subnet ( /24) also hosts several known or suspected apt28 domains, as seen in table 1. the target firm is an international government entity in an industry vertical that aligns with known apt28 targeting. cve-2015-1701 exploit
the payload contains an exploit for the unpatched local privilege escalation vulnerability cve-2015-1701 in microsoft windows. the exploit uses cve-2015-1701 to execute a callback in userspace. the callback gets the eprocess structures of the current process and the system process, and copies data from the system token into the token of the current process. upon completion, the payload continues execution in usermode with the privileges of the system process. because cve-2015-3043 is already patched, this remote exploit will not succeed on a fully patched system. if an attacker wanted to exploit cve-2015-1701, they would first have to be executing code on the victim s machine. barring authorized access to the victim s machine, the attacker would have to find some other means, such as crafting a new flash exploit, to deliver a cve-2015-1701 payload. microsoft is aware of cve-2015-1701 and is working on a fix. cve-2015-1701 does not affect windows 8 and later. acknowledgements
thank you to all of the contributors to this blog! the following people in fireeye: dan caselden, yasir khalid, james tom bennett, genwei jiang, corbin souffrant, joshua homan, jonathan wrolstad, chris phillips, darien kindlund
microsoft & adobe security teams this entry was posted on sat apr 18 12:10 edt 2015 and filed under fireeye labs.
