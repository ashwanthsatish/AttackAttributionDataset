let it ride: the sofacy group s dealerschoice attacks continue
robert falcone	by robert falcone and bryan lee
december 15, 2016 at 5:00 am
category: unit 42 tags: dealerschoice, sofacy, threat research recently, palo alto networks unit 42 reported on a new exploitation platform that we called dealerschoice in use by the sofacy group (aka apt28, fancy bear, strontium, pawn storm, sednit). as outlined in our original posting, the dealerschoice exploitation platform generates malicious rtf documents which in turn use embedded ole word documents. these embedded ole word documents then contain embedded adobe flash (.swf) files that are designed to exploit abode flash vulnerabilities. at the time of initial reporting, we found two variants: variant a: a standalone variant that included flash exploit code packaged with a payload.
variant b: a modular variant that loaded exploit code on-demand and appeared non-operational at the time.
since that time, we have been able to collect additional samples of the weaponized documents that the dealerschoice exploitation platform generates. these latest, additional samples are all variant b samples. two of these samples were found to have operational command and control servers which allowed us to collect and analyze additional artifacts associated with the attack. in late october 2016 adobe issued adobe security bulletin apsb16-36 to address cve-2016-7855. in early november 2016 microsoft issued microsoft security bulletin ms16-135 to address cve-2016-7255. both of these were in response to active exploitation of zero-day vulnerabilities thought by other researchers to be associated with the sofacy group. additional reporting as well as our own analysis indicates the exploit code for the adobe flash vulnerability cve-2016-7855 was indeed delivered using dealerschoice. in-house testing also reveals customers of palo alto networks traps end-point agent are protected by the new exploit code. deal me in: finding live c2 servers
in our previous blog discussing dealerschoice, we identified the steps that variant b would take once executed on a victim host, but were unable to successfully interact with the command and control (c2) server identified at the time. we have since discovered two fully operational and active c2 servers (versiontask[.]com and postlkwarn[.]com) that followed the exact steps we outlined in the blog; loading the additional flash exploit code into memory, following by loading the associated payload also into memory. figure 1 details the workflow of victim to c2 communications. dealerschoice2_1 figure 1 workflow of dealerschoice the actionscript within variant b will interact with the c2 server, specifically to obtain a malicious swf file and a payload. this process starts with an initial beacon to the c2 server that contains system information and the victim s adobe flash player version. figure 2 shows the beacon sent by the actionscript to the c2 server. dealerschoice2_2 figure 2 initial beacon from dealerschoice to its c2 server the c2 responds to the initial beacon with strings that dealerschoice s actionscript uses as variables in upcoming actions, such as additional http requests and the decryption of the responses to those requests. figure 3 shows the c2 server s response to the beacon, specifically including k1, k2, k3 and k4 values. dealerschoice2_3 figure 3 c2 response to beacon provides dealerschoice tokens and keys needed to decrypt data the actionscript then uses the k1 variable from the c2 response data as a token within the http request sent back to the c2 server to obtain the malicious swf file, as seen in figure 4. the c2 server will respond to this request with data that the actionscript will decrypt using the value of the k3 variable. the active c2 servers provided variant b with a malicious swf file that was the same swf file found within variant a samples that exploited cve-2015-7645 (addressed in october 2016 in adobe security bulletin apsa15-05). after receiving the malicious swf file, variant b will then issue an http request using the k2 variable as a token to obtain its payload, as seen in figure 5. the c2 will respond to this request with data that variant b will decrypt using the value in the k4 variable as a key. the resulting decrypted data contains shellcode and a payload that the shellcode decrypts and executes. the active c2 servers versiontask[.]com and postlkwarn[.]com provided shellcode that decrypts and executes a payload which in both cases was a loader trojan that extracts and decrypts an embedded dll that it saves to the system. in both cases, the dll saved to the system is a variant of sofacy s tool that uses the carberp source code. the two variants of the seduploader tool share a common c2 domain of apptaskserver[.]com, with differing backup c2 domains of appservicegroup[.]com and joshel[.]com. ace in the hole: analyzing victim fingerprinting
in the process of analyzing variant b s active c2 server, we wanted to test our hypothesis that the c2 server would load different exploit code dependent on victim fingerprinting. we tested this by providing different responses to the c2 server. first, we issued requests to the c2 server from a vpn located in california, usa and the server did not respond to the requests. we then connected to another vpn located in the middle east and issued the same requests, at which point the c2 server responded with a malicious swf and payload. this fact suggests that the sofacy group uses geolocation to filter out requests that originate from locations that do not coincide with the location of their target. we then issued several requests to test the c2 and each time the server responded with different k1, k2, k3 and k4 variables, suggesting that the server randomly chooses these values for each inbound request. to further test the c2 server logic we created requests that contained different values for the operating system and flash player version. when we sent the http requests to the c2 server with the adobe flash player version set to , the most recent flash version vulnerable to cve-2016-7855, the server responded with a compressed swf file finally, when we issued requests to the c2 server indicating the victim was a macos system, the c2 server served the same malicious swf file and windows payload as before, suggesting that the sofacy group is not using dealerschoice to check operating system type for its victims at this time. show your hand: decoy documents
six documents were collected for this wave of dealerschoice attacks, all appearing to be variant b, using similar lures to what we had observed in the previous wave. the six filenames we discovered were: an article about turkish troops in mosul a document that is a copy of an article regarding the purchase of a norwegian missile defense system by the lithuanian ministry of national defence a document that is a copy of the schedule of a cyber threat intelligence conference in london, targeting a ministry of defense of a country in europe a document targeted at a ministry of foreign affairs of a central asian country regarding the agenda for the defence geospatial intelligence gathering in london
olympic-agenda-2020-20-20- a document containing details of agreements for the 2020 olympics
arm- a document outlining an agreement between the republic of armenia and nato
dealerschoice_figure_6 figure 6. collected decoy documents for current wave of attacks unlike the first dealerschoice attacks, these documents used stripped out or forged metadata in order to add in an additional layer of obfuscation. two of the documents, and shared a common, unique username pain in the last saved by field. additionally, each of the weaponized documents continued to use the officetestsideloading technique we had previously reported on. this was the technique we had discovered the sofacy group began using over this past summer as a way to sideload dll files using a performance test module built into the microsoft office suite as well as maintain persistence on the victim host. the six first-stage c2 domains for the weaponized documents were all registered by unique registrant emails. versiontask[.]com and uniquecorpind[.]com appear to be completely new infrastructure, not sharing any artifacts with previously observed sofacy group campaigns. six second stage c2 domains for the seduploader payloads delivered by dealerschoice were identified. much like the first stage c2 domains, the five non-sinkholed second stage c2 domains were registered recently and used unique registrant email addresses previously unused by the sofacy group. however, each of these domains used nameservers commonly associated with the sofacy group, ns*.carbon2u[.]com and ns*.ititch[.]com. the domain akamaisoftupdate[.]com revealed additional artifacts linking it back to previous sofacy group campaigns. based off passive dns data, we discovered akamaisoftupdate[.]com resolving to . on the same class c subnet, we discovered , which previously had resolved to updmanager[.]net, a well reported domain in use by the sofacy group. the domain securityprotectingcorp[.]com was also found to have links to previous sofacy group infrastructure. it was registered a couple of months prior, but analysis of the registrant email address revealed that it had also been used to register microsoftsecurepolicy[.]org, which using passive dns data we found had resolved to , a sinkhole with several other sofacy group associated domains. several of the corresponding sinkholed domains have been used over the years for multiple purposes by the sofacy group, as c2s for multiple tools such as azzy or xagent, or to host phishing sites to gather credentials from targets. dealerschoice2_7 figure 7 chart of dealerschoice infrastructure conclusion
it appears evident at this time that the sofacy group is actively using the dealerschoice tool, specifically the variant b, to attack targets of interest. as evidenced by the delivery of exploit code for a recently patched vulnerability in flash (which was used in zero-day attacks), we can see how the malware provides flexibility in exploitation methodology and is truly a platform in itself. new infrastructure does appear to have been created for dealerschoice, but as we have seen in the past, the sofacy group has a tendency to reuse artifacts from previous campaigns and this is no exception. palo alto networks customers may learn more and are protected via: correctly identify associated samples as malicious in wildfire
dealerschoice domains and c2 traffic are classified as malicious
traps correctly identifies and prevents exploit code to be executed
a dealerschoice autofocus tag may be used to identify and track this malware family
note that even though cve-2016-7855 was a zero-day vulnerability, palo alto networks customers would have been protected by our traps endpoint agent as seen in figure 8. 