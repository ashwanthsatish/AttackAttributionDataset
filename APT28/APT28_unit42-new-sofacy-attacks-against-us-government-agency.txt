new sofacy attacks against us government agency by robert falcone and bryan lee
june 14, 2016 at 5:00 am
category: unit 42 tags: apt28, carberp, ministry of foreign affairs, sofacy, trojan the sofacy group, also known as apt28, is a well-known threat group that frequently conducts cyber espionage campaigns. recently, unit 42 identified a spear phishing e-mail from the sofacy group that targeted the united states government. the e-mail was sent from a potentially compromised account belonging to the ministry of foreign affairs of another government entity and carried the carberp variant of the sofacy trojan. the developer implemented a clever persistence mechanism in the trojan, one which had not been observed in previous attacks. the focus of this blog will be on the attacks and the infrastructure associated with sofacy using the new persistence mechanism as a correlation point. the delivery
on may 28, 2016, attackers sent a spear-phishing e-mail to a u.s. government entity using an email address belonging to the ministry of foreign affairs of another country. analysis of the attack revealed a high likelihood that the sender s email address was not spoofed and is instead a result of a compromised host or account belonging to that ministry. the targeted email had a subject of fw: exercise noble partner 2016 , which is a reference to a joint nato training effort between the united states and georgia. the email contained an rtf file as an attachment, with the filename , reflecting the same training exercise. we have also seen related delivery documents with filenames that have a russian military theme ( and russian anti-nato ), purportedly targeting organizations in poland according to a blog published by prevenity. the rtf file is a weaponized document that attempts to exploit cve-2015-1641 to drop two files to the system, specifically, and . the file is a trojan that loads and executes , which is a carberp variant the sofacy trojan. surprisingly, unlike many other espionage actors who display decoy documents after successful exploitation, this rtf document does not drop or open a decoy document after exploiting the vulnerability. in the installation process, we observed the delivery document creating a very interesting registry key that it uses for persistence to run the trojan. the path to the file is added to the following registry key: this registry key is interesting, because unlike traditional methods of maintaining persistence, it does not automatically run the file at system start up. instead, this registry key will cause the dll to load only when the user opens any microsoft office application, such as word or excel. this is the first time unit 42 has seen the sofacy group, or any other threat group for that matter, use this tactic for persistence purposes. an added benefit for the threat actor to using this specific tactic for persistence is that it requires user interaction to load and execute the malicious payload, which can cause challenges for detection in automated sandboxes. the carberp variant of sofacy
the file is the loader trojan that is responsible for loading the dll and executing it. both the and files contain code from the leaked carberp source code, specifically the api resolution functions, as well as the rc2 key. the sofacy group has used the carberp source code in the past, specifically discussed in a blog by f-secure, which is the reason we call this trojan the carberp variant. the file contains the bulk of the functionality of this trojan, which at a high level is a downloader that allows the threat actors to gain an initial foothold on the system. the trojan sends network beacons to its command and control (c2) serverallowing the threat actors to identify targets of interest. the threat actors can then respond to these network beacons to download and execute additional secondary payloads on the system. the trojan delivered in this attack contains two network locations that it will send network beacons to, specifically and . these beacons are sent to the legitimate website as an attempt to hide the true c2 beacons sent to the actual c2 server hosted at . the network beacons are sent using http post requests with urls created largely with random characters. there are two exceptions where random characters are not used to construct the url, specifically the file extension that is randomly chosen from .xml, .pdf, .htm or .zip and the base64 encoded value at the end of the url. the base64 encoded data is a string ( j04alsxvhhbkr19cyr0 ) hardcoded within the trojan that it will then encrypt using a custom algorithm. figure 1 shows an example beacon sent from the trojan to the c2 server during analysis. the post data seen in the beacon in figure 1 is base64 encoded and encrypted using the same custom algorithm used to encrypt the data in the beacon url. we decrypted the data to determine its purpose and found the cleartext seen in figure 2.
the clear text of the data sent in the network beacons contains information regarding the compromised system, as well as malware-specific information. the data is comprised of the following fields of data: this callback data allows the threat actors to determine if the infected machine is a target of interest, as the beacon contains a list of running processes and the name of the storage device that could be used to filter out analysis systems or researchers. if the actors believe the system is of interest, they will respond to these network beacons to download and execute additional secondary payloads on the system. the trojan parses the response to the beacons for two actions execute and delete between the tags [file] and [/file] , as well as settings labeled filename , pathtosave , rundll and ip between the tags [settings] and [/settings] . this allows the threat actors to download additional files to the system, execute both executables and dlls and delete files. the infrastructure
the initial analyzed sample in this attack only contained a single malicious command and control location, . we have not observed this ip address used by the sofacy group in any previous attack campaigns, and examining passive dns data showed no other correlations to potentially related attacks. the sample also seen by prevenity appeared to only have a single primary c2 domain, servicecdp[.]com. this domain also appears to be newly created for this specific attack campaign, with no strong links to any previous attacks. pivoting off the unique registry key used for persistence revealed links to a previously observed sofacy campaign, from mid-2015. two additional payloads with recent compile dates of march 7, 2016, were discovered using the same persistence mechanism, and analysis of those payloads revealed one primary c2 domain, munimonoce[.]com, and three secondary c2 domains, www.wscapi[.]com, www.tabsync[.]net, and storsvc[.]org. the secondary c2 domains may appear familiar, as they were widely publicized in a report from isight partners in july 2015 as c2 domains related to the sofacy group aka tsar team. in addition, the primary c2 domain munimonoce[.]com previously had resolved to the ip , which was previously identified as a primary c2 ip for a sofacy payload with a compile timestamp of june 11, 2015. this particular sample also happened to use the exact same secondary c2 domains of www.wscapi[.]com, www.tabsync[.]net, and storsvc[.]org, but lacked the newly discovered persistence mechanism. the sofacy group often re-uses infrastructure components across multiple attack campaigns, whether to speed the flow of attacks, for a lack of available resources committed, or out of sheer laziness. in this case, the newer attack campaign appears to use newly created infrastructure, but still maintains some overlap with previous sofacy-related c2s. we believe this overlap could possibly be due to an oversight when adapting a previous code base with the new persistence method discussed in this blog for the new attack campaign. the threat appears to be moving toward deployment of one-off infrastructure that can make analysis of attack campaigns and correlation more challenging. this shift stresses the importance of analysts and researchers being able to pivot on all artifacts of a given attack, not simply relying on network indicators. in this case, we were able use autofocus to pivot on a common registry key unique to this attack campaign to quickly identify where it correlates with characteristics of previous attacks. conclusion
the sofacy group continues its attack campaigns on government organizations, specifically the u.s. government in this latest spear-phishing example. the threat group added a new persistence mechanism that requires user interaction by loading its payload into microsoft office applications when opened, which may help the actors to evade detection. the use of this new persistence method shows the continued development of tactics and techniques employed by this threat group, often times in clever ways as we observed in this instance. palo alto networks customers are protected from the new sofacy carberp variant and can gather additional information using the following tools: wildfire detection of all known samples as malicious
all known c2s are classified as malicious in pan-db
autofocus tags have been created sofacycarberp
