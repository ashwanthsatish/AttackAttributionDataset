recently, we discovered a new ie zero-day exploit in the wild, which has been used in a strategic web compromise. specifically, the attackers inserted this zero-day exploit into a strategically important website, known to draw visitors that are likely interested in national and international security policy. we have identified relationships between the infrastructure used in this attack and that used in operation deputydog. furthermore, the attackers loaded the payload used in this attack directly into memory without first writing to disk a technique not typically used by advanced persistent threat (apt) actors. this technique will further complicate network defenders ability to triage compromised systems, using traditional forensics methods. on november 8, 2013 our colleagues xiaobo chen and dan caselden posted about a new internet explorer 0-day exploit seen in the wild. this exploit was seen used in a strategic web compromise. the exploit chain was limited to one website. there were no iframes or redirects to external sites to pull down the shellcode payload. through the fireeye dynamic threat intelligence (dti) cloud, we were able to retrieve the payload dropped in the attack. this payload has been identified as a variant of trojan.apt.9002 (aka hydraq/mcrat variant) and runs in memory only. it does not write itself to disk, leaving little to no artifacts that can be used to identify infected endpoints. specifically, the payload is shellcode, which is decoded and directly injected into memory after successful exploitation via a series of steps. after an initial xor decoding of the payload with the key "0x9f", an instance of is launched and injected with the payload using createprocessa, openprocess, virtualalloc, writeprocessmemory, and createremotethread. after transfer of control to the injected payload in , the shellcode is then subjected to two more levels of xor decoding with the keys '0x01', followed by '0x6a'. process execution is then transferred to the final decoded payload, which is a variant of the 9002 rat. the fact that the attackers used a non-persistent first stage payload suggests that they are confident in both their resources and skills. as the payload was not persistent, the attackers had to work quickly, in order to gain control of victims and move laterally within affected organizations. if the attacker did not immediately seize control of infected endpoints, they risked losing these compromised endpoints, as the endpoints could have been rebooted at any time thus automatically wiping the in-memory trojan.apt.9002 malware variant from the infected endpoint. alternatively, the use of this non-persistent first stage may suggest that the attackers were confident that their intended targets would simply revisit the compromised website and be re-infected. command and control protocol and infrastructure this variant connected to a command and control server at over port 443. it uses a non-http protocol as well as an http post for communicating with the remote server. however, the callback beacons have changed in this version, in comparison to the older 9002 rats. the older traditional version of 9002 rat had a static 4-byte identifier at offset 0 in the callback network traffic. this identifier was typically the string "9002", but we have also seen variants, where this has been modified such as the 9002 variant documented in the sunshop campaign. in contrast, the beacon from the diskless 9002 payload used in the current ie 0-day attack is remarkably different and uses a dynamic 4-byte xor key to encrypt the data. this 4-byte key is present at offset 0 and changes with each subsequent beacon. fireeye labs is aware that the 4-byte xor version of 9002 has been in the wild for a while and is used by multiple apt actors, but this is the first time we ve seen it deployed in the diskless payload method. the xor decoded data always contains the static value at offset 16. this value is in fact hardcoded in packet data construction function prior to xor encoding. this value most likely is the date "2011-12-09" but its significance is not known at this time. the diskless 9002 rat payload also makes a post request, which has also changed from the traditional version. it has base64 stub data, instead of the static string "aa". the user-agent string and uri pattern remain the same however. it uses the static string "lynx" in the user-agent string and the uri is incremental hexadecimal values. the data in the post stub is also encrypted with a 4-byte xor key, and when decrypted, the data is similar to the data in the non-http beacon and also has the static value "\x09\x12\x11\x20". campaign analysis passive dns analysis of this domain revealed that it resolved to between 2011-09-23 and 2011-10-21. the following other domains have also been seen resolving to this same ip address: if the domain rings a bell, it should. while covering a different internet explorer zero-day (cve-2013-3893) and the associated operation deputydog campaign, we reported that the cnc infrastructure used in that campaign overlapped with this same domain: . inside the in-memory version of the trojan.apt.9002 payload used in this strategic web compromise, we identified the following interesting string: rat_uninstall . through dti, we found this same string present in a number of different samples including the ones discussed above: based on this analysis, all of these samples, including the in-memory variant, can be detected with the following simple yara signature: we also found the following strings of interest present in these above 9002 rat samples (excluding the in-memory variant): these strings were all observed and highlighted by bit9 here. as bit9 notes in their blog, trojan.apt.9002 (aka hydraq/mcrat) was also used in the original operation aurora campaign, and the rat_uninstall string can be found in the original aurora samples confirming the lineage. conclusions by utilizing strategic web compromises along with in-memory payload delivery tactics and multiple nested methods of obfuscation, this campaign has proven to be exceptionally accomplished and elusive. apt actors are clearly learning and employing new tactics. with uncanny timing and a penchant for consistently employing zero-day exploits in targeted attacks, we expect apt threat actors to continue to evolve and launch new campaigns for the foreseeable future. not surprisingly, these old dogs continue to learn new tricks.
