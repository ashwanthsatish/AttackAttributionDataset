oilrig malware campaign updates toolset and expands targets
josh grunzweig	by josh grunzweig and robert falcone
october 4, 2016 at 1:10 pm
category: unit 42 tags: clayside, helminth, oilrig, oilrig attacks, spearphishing since our first published analysis of the oilrig campaign in may 2016 , we have continued to monitor this group for new activity. in recent weeks we ve discovered that the group have been actively updating their clayslide delivery documents, as well as the helminth backdoor used against victims. additionally, the scope of organizations targeted by this group has expanded to not only include organizations within saudi arabia, but also a company in qatar and government organizations in turkey, israel and the united states. expanded targeting
the group behind the oilrig campaign continues to leverage spear-phishing emails with malicious microsoft excel documents to compromise victims. as an example, the following email was sent to a turkish government organization using a lure of purported new portal logins for an airline s website. (please note that the sender email used in the figure below may have been spoofed.) figure 1 phishing email sent to turkish government organization when the file is executed and macros are enabled, the victim is presented with the following decoy document. oilrig_2 figure 2 content contained in malicious helminth xls file this same document content was used with helminth samples targeting government organizations in multiple nations. for those particular attacks, the following filenames were witnessed: help- in addition to these instances, multiple qatari organizations were the subject to spear phishing attacks carrying helminth samples earlier this year. in those cases, the documents used to carry the malicious macro code were very specific to the organization receiving them and in some cases were sent from partner organizations that already had a relationship with the recipient. updates to toolset
in recent months, we ve tracked a number of changes to the malware used by the actors responsible for oilrig. in the past five months, we ve identified four distinct variants, each of which drops different filenames upon execution. these variants use the following filenames when dropped. (please note that fireeye was notified about the use of their company name in the malware upon discovery.) as we can see in the above timeline, the attackers shifted from the update.vbs variant of their malware in late may 2016 to use the fireeye.vbs variant. more recently, the upd.vbs variant was discovered, which appears to be an actively developed copy. comments and other artifacts were discovered in this variant, which will be discussed further later in this post. more recently, the komisova.vbs variant was discovered to be used. changes in vbscripts between variants
overall, there are minimal changes in the dropped vbs files between variants. as a reminder, the vbs script is responsible for communicating with a remote server via http. the script repeatedly attempts to download a file from the remote server, and proceeds to execute it when available. the output of this file is then uploaded via another http request. it will also execute the powershell script that is dropped by the clayslide excel documents. overall, there are minor differences between the variants observed. the main differences appear to be in the domains and ip addresses used. the following urls are used by each: a few things to note include the fact that the komisova.vbs variant uses the same url witnessed in the fireeye.vbs variant. it s worth pointing out that this domain was only seen in the most recent fireeye.vbs variants, so it s very possible that it was used in a transition phase when the attackers were switching over to komisova. we previously mentioned that the excel file dropping upd.vbs was likely a development version. evidence supporting this claim includes the fact that an ip address connection using a non-standard port was used for this file. one particularly interesting feature of this ip address is that it has ties to the remexi report issued by symantec in late 2015. this is in-line with previous evidence suggesting an iranian-based actor behind these attacks. the underlying code of upd.vbs is much cleaner when comparing it against the other variants. this can be seen below. this provides additional evidence that it is being actively developed. figure 8 differences between upd.vbs and komisova.vbs another minor difference observed in the upd.vbs variant is the location of files that are downloaded. the three other variants all place downloaded file within a subfolder that resides in %public%/libraries. however, this particular one-off places its files within subfolders that reside in %userprofile%/appdata/local/microsoft/media/. changes in ps1 between variants
similar to the vbs file, the ps1 file will also communicate with a remote server. unlike the vbs file, the ps1 file uses dns instead of http. commands and file locations are received by the remote server, executed, and the output of these commands is in turn uploaded via additional dns requests. for an in-depth analysis on how this occurs, please refer to our previous oilrig blog post. overall, there are very minor differences between the dns, fireeye, and komisova ps1 variants. however, the dn.ps1 variant looks to have been updated considerably. in addition to these updates, the file is also heavily commented, providing further evidence that this particular file is being actively developed. n the above queries, the rne command will ask the remote server if a normal file is available for download. if it is, the server will respond with a response of ok , followed by the filename. in such a situation, the malware will perform the rd command, which will actually download the file in question. similarly, the same execution flow is seen for the bne and bd commands respectively, only this particular operation is looking for a batch file. in the event the malware is downloading files, it will look for a string of eofeof to signal the end of the data stream. the u command is used to upload data that is generated from any provided files or scripts. data is uploaded in chunks, with the byte_position variable holding the current byte position of the uploaded file. we ran this particular variant for a number of days, and were able to solicit the attackers to interact with our honeypot. a python script was used to parse the collected pcap, with the following results (truncated for brevity): s we can see, a number of interesting commands were received by the attackers, including attempts to communicate with remote ftp servers and various reconnaissance commands. these commands came at seemingly random intervals, indicating they likely resulted from an actual attacker issuing them, versus an automated system. conclusion
the attackers using the helminth and clayslide malware families continue to target various high value companies and organizations across the globe using their customized malware. this malware is under active development and continues to be updated and improved upon, as witnessed in the files discussed in this blog post. while the malware deployed is not terribly sophisticated, it uses techniques such as dns command and control (c2) that allows it to stay under the radar at many establishments. palo alto networks customers are protected against this threat in the following ways: wildfire identifies all helminth and clayslide samples as malicious
domains identified as command and control servers are flagged as malicious
autofocus tags helminth and clayslide may be used to track this group
