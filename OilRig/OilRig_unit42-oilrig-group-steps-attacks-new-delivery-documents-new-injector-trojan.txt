oilrig group steps up attacks with new delivery documents and new injector trojan
robert falcone	by robert falcone and bryan lee
october 9, 2017 at 10:00 am
category: unit 42 tags: ismagent, isminjector cve-2017-0199, oilrig, threedollars unit 42 s ongoing research into the oilrig campaign shows that the threat actors involved in the original attack campaign continue to add new trojans to their toolset and continue their persistent attacks in the middle east. when we first discovered the oilrig attack campaign in may 2016, we believed at the time it was a unique attack campaign likely operated by a known, existing threat group. as we have progressed in our research and uncovered additional attack phases, tooling, and infrastructure as discussed in our recent posting striking oil: a closer look at adversary infrastructure , it has become apparent that the threat group responsible for the oilrig attack campaign is likely to be a unique, previously unknown adversary. additionally, others have been referring to the group responsible for the oilrig campaign itself as the oilrig group as well. to that end, we are elevating the oilrig attack campaign to be known as the oilrig group. in july 2017, we observed the oilrig group using a tool they developed called ismagent in a new set of targeted attacks. the oilrig group developed ismagent as a variant of the ismdoor trojan. in august 2017, we found this threat group has developed yet another trojan that they call agent injector with the specific purpose of installing the ismagent backdoor. we are tracking this tool as isminjector. it has a sophisticated architecture and contains anti-analysis techniques that we have not seen in previous tools developed by this threat group. the complex structure and inclusion of new anti-analysis techniques may suggest that this group is increasing their development efforts in order to evade detection and gain higher efficacy in their attacks. the attack
on august 23, 2017, we observed oilrig targeting an organization within the united arab emirates government. the attack involved a spear-phishing email that had a subject of importan issue and two zip archives attached, as seen in figure 1. note that important is misspelled in the sample as shown below. oilriginjector_1 figure 1 delivery email that contains two zip archives that contain the malicious delivery documents the message body in the attack email contains an image that is hosted on a remote server. as shown in figure 2, hovering over the image shows that the url link is to an image hosted at www.cdnakamaiplanet[.]com which we have reason to believe is an adversary owned domain. it is likely that the image was embedded to track if the recipient opened the email or not. oilriginjector_2 figure 2 url associated with image included in delivery email another interesting facet of this attack is that the email addresses in the to and from fields are from addresses from the same domain. our initial assumption was that the email address in the from field was likely spoofed. additional analysis of the email headers revealed that it did not contain a list of external email servers used to deliver the message as expected from a spoofed email; instead, we discovered the following string within the email headers: client=owa;mozilla/5.0 (windows nt 6.3; rv:36.0) gecko/20100101 firefox/36.04; this string in the header suggests that the oilrig actor is likely to have used the targeted organization s outlook web access (owa) to send the phishing email using firefox 36. using information from our research in the striking oil blog, we know the oilrig group has conducted credential harvesting campaigns specifically by emulating owa login sites. based on that research and this observation, we postulate that the oilrig group gathered credentials to a legitimate user s owa account and logged into the user s account to send phishing attacks to other individuals within the same, targeted organization. also, firefox 36 was released in february 2015; since this email was sent august 2017, we believe it suggests the actors are using an outdated version of firefox to log into the target organization s owa. the delivery
the august 23, 2017 phishing attack contained two zip archives to the email, issue- and issue- . each zip attachment contains one file, with within issue- and issue.dot within issue- . the and issue.dot files are both malicious documents that will attempt to run in microsoft word. is a word document that contains a malicious macro that the actors attempt to trick the victim into executing by instructing the user to click the enable content button as shown in figure 3. we track this malicious delivery document as threedollars. s displayed by the code example above, index.dot file attempts to load a malicious exploit document hosted at msoffice-cdn[.]com , which is the same url that hosted the exploit document used in an attack that clearsky published on august 28, 2017. by correlating artifacts found in index.dot, we discovered another sample attempting to exploit cve-2017-0199 used in a separate attack, this time using office365-management[.]com as the c2 domain. the resulting payload from this related delivery document is an ismagent trojan that is configured to use msoffice365update[.]com as its c2 server. please reference our previous blog on ismagent for more information on this trojan. isminjector
ultimately, the payload delivered by threedollars is a new tool that we track as isminjector. as its name suggests, isminjector is a trojan that is responsible for injecting a trojan into another process. the payload embedded within the isminjector sample delivered in this attack is a variant of the ismagent backdoor that we had discussed in detail in our blog discussing a targeted attack on a saudi arabian technology company. at face value, isminjector is obfuscated with the off-the-shelf smartassembly .net obfuscator created by red- . the first execution of isminjector starts by copying itself to %localappdata% and enables persistent access to the system. the code achieves persistence by referencing two resources that contain commands the code will execute by running them within a command prompt process, as seen in the following screenshot: the two resources that contain commands that isminjector uses for persistence are named tsk1 and tsk2 . the specific commands within each of these resources are within table 1. at a high level, the tsk1 command creates a scheduled task named reporthealth that is meant to run a payload saved to %localappdata% every 4 minutes. the tsk2 command creates a scheduled task that runs every 2 minutes that is responsible for saving the payload to . this task saves the payload to this location using the certutil command to decode the original payload saved to . table 1 resources in isminjector containing commands for persistence subsequent executions of the isminjector sample from will execute its functional code. isminjector s functional code is split into two different embedded modules named and that work in conjunction to inject an embedded ismagent payload into another process. the two modules, which we will refer to as joiner and inner, have the following debug paths, which suggest the author of these modules refer to this trojan as agent injector : the main function within the isminjector assembly uses the joiner module to construct the final payload and the inner module to inject the final payload into a process. figure 4 shows the isminjector s main function that uses the two modules to carry out its injection process before exiting. the joiner module contains four resources named p11, p12, p21 and p22, which are all 35840 bytes of binary data. it reads the p11 and p12 resources and saves them to a variable, effectively concatenating them together. the module uses the same logic to concatenate the p21 and p22 resources together, and finally concatenates the p11+p12 variable with the p21+p22 variable, which results in the construction of a binary executable. the isminjector code then calls the loaddll method within the inner module, providing the string run , the payload constructed by the joiner module, and a path to the executable as arguments, as seen in figure 4. the loaddll method constructs an embedded assembly, using the same method as the joiner module used to construct the final payload. however, the inner module creates another module that is used to actually perform the code injection. to create this embedded module, the inner module references two resources named d1 and d2 and concatenates them together. the resulting .net assembly has a class called clsv2 that has a method named run , which is called in the loaddll function call shown in figure 4. the run method within the clsv2 class is invoked to execute the payload. the run method calls functions that has a state machine that dictates the actions taken. at a high level, these state machines attempt to create a process and inject the constructed payload into the newly created process. the use of state machines complicates analysis efforts because it makes the flow of execution jump around in a non-sequential fashion. table 2 contains the path through the state machines that isminjector uses to create a remote process, inject its embedded payload then run the payload. each row of the table contains the current state, a description of the activities performed within that state, as well as the next state that will be set and run. the state values jump around dramatically, which requires an analyst to also jump around the code to determine its functionality. this is an interesting anti-analysis technique we have not seen the oilrig actors use in their other tools. the executable injected into the process is a variant of the ismagent trojan, which is very similar in behavior to the ismagent payload discussed in our previous blog. this ismagent payload is configured to use cdnmsnupdate[.]com as its c2 server using both http and dns tunneling channels. it appears the oilrig group may have simply repurposed the injection code from an open source file called , which is available on github and codegists. the actors did not use this code without modification; instead, they used state machines as an obfuscation technique to disguise the injection code. the path that isminjector takes through the state machine and the activities are almost identical to the activities carried out in the code. it is also possible that this portion of the isminjector was obfuscated by a crypter that the threat actors used to further complicate analysis. infrastructure
beginning with the initial phishing email, we discovered a significant infrastructure for this attack wave that also showed relationships to previous oilrig attack campaigns both from an infrastructure perspective and shared code. much like previous oilrig attacks, the c2 domains used typo-squatting techniques in order to attempt to evade detection. the image embedded within the phishing email is hosted on cdnakamaiplanet[.]com, which resolves to . as with other oilrig attacks, this ip is not reused to resolve to any other domain. however, two other ips on the same /24 netblock are found to be used as c2s. is found to resolve to microsoft-publisher[.]com, which we observed as a c2 for our initial ismagent finding. resolves to adpolioe[.]com, hich appears to be a typo-squatted domain that also hosts a sample of ismagent at hxxp://82.102.14[.]246/webdav/aws.exe. this sample s c2 is cdnmsnupdate[.]com which turns out to be the c2 server for three other samples, one ismagent and two of them being ismagentinjector. reverse resolution of this domain provides us the ip , which again is not used for any other domain resolution. another ip on the same /24 is found at resolving to msoffice365update[.]com which happens to be the c2 domain for the ismagent payload delivered by the malicious document exploiting cve-2017-1099 mentioned earlier in this blog. as previously discussed, the .dot file attempting to exploit cve-2017-0199 uses msoffice-cdn[.]com as a c2 to retrieve additional malicious code. reverse resolution of this domain shows an ip of , which shares a /24 netblock with . this ip resolves to office365-management[.]com which is the c2 for a secondary .dot file we were able to collect in this attack wave. in figure 5 below you can see the oilrig infrastructure for isminjector that our research uncovered. isminjector copy conclusion
the oilrig group continues to target organizations in the middle east, in this instance targeting the government of the united arab emirates. they continue to use the ismagent trojan as the final payload in their attacks, this time in conjunction with a custom injector trojan to assist with delivery and execution. the injector trojan was obfuscated using a known crypter and used state-machines as an anti-analysis technique to complicate its process to inject the payload into another process. the use of crypters and anti-analysis techniques suggests that the threat actors are increasing their efforts to evade security products to successfully compromise its targets. as our research continues to expand into the oilrig group, we are continuously discovering new infrastructure which directly overlaps with previously used infrastructure. with the addition of the reuse of tools, similar attack protocols, as well as consistent victimology, we have strong confidence that the original oilrig attack campaign is indeed a single, unique, and previously unknown threat group that will hereby be referred to as the oilrig group. palo alto networks customers are protected from isminjector, ismagent and threedollars by the following: all isminjector, ismagent and threedollars samples are marked with a malicious verdict in wildfire
autofocus customers can track these malware families via:
isminjector
ismagent
threedollars 