fin7 takes another bite at the restaurant industry
posted by michael gorelik on june 9, 2017 at 11:40 am introduction
on june 7, 2017, morphisec lab identified a new, highly sophisticated fileless attack targeting restaurants across the us. the ongoing campaign allows hackers to seize system control and install a backdoor to steal financial information at will. it incorporates some never before seen evasive techniques that allow it to bypass most security solutions signature and behavior based. aside from these updated techniques, morphisec s investigation revealed an almost perfect match to fin7 attack methods. past highly successful and damaging attacks on banks, sec personnel, large restaurant chains and hospitality organizations have all been attributed to the financially-motivated fin7 group. fin7, which is also associated with the carbanak gang, must be seen as one of the leading threat actor groups operating today. like past attacks, the initial infection vector is a malicious word document attached to a phishing email that is well-tailored to the targeted business and its day-to-day operations. the word document executes a fileless attack that uses dns queries to deliver the next shellcode stage (meterpreter). however, in this new variant, all the dns activity is initiated and executed solely from memory unlike previous attacks which used powershell commands. opendns investigate data, shared in coordination with the cisco advanced threat research & efficacy team, shows that this is a large-scale, currently active attack with peaks of more than 10k dns requests per hour. alarmingly, the detection score on virustotal for all of the documents continues to be 0/56 from the time the first documents were uploaded (1.6.2017) up until the date of this publication. this means the attackers successfully bypass static analysis by most of the security solutions. by contrast, morphisec s moving target defense-based technology prevents the attack in its early stages, before any channel to the attacker is opened. technical analysis
below we describe the full technical details, beginning with the initial email through the final meterpreter session used to hijack the computer. as seen in the email below, fin7 s attack campaign targets restaurants. the content of the email is well crafted to avoid suspicion. some of the email attachments are called , others olive or chick fil a (all the identified hashes are listed at the end). the attached .rtf file uses ole and has many similarities to previous fin7 attacks. but this attack, instead of activating hta files ( ) from within the link, executes obfuscated javascript code. all the victim needs to do is double click on the envelope and press ok. the first stage javascript copies additional javascript code snippets in txt format from the rtf document into a random directory c:\users\<user name>\<random guid>\ . the same code snippets are combined into a second stage javascript in c:\users\<user name>\ . additionally, the first stage javascript creates a scheduled task that executes the second stage code within a minute this delayed execution helps to bypass behavior analysis since the second stage is not directly executed by the first stage. in some cases, an additional scheduled task adobeflashsync is created for persistency. this task is executed every 25 minutes and will repeat the actions described above recreating the javascript code which later will create and execute a powershell script (described below). second stage javascript into powershell: the second stage javascript creates a powershell file with the same name in the same directory. afterwards, it deletes its own javascript code traces. the powershell script executes a compressed first stage powershell child process, which then performs a second stage powershell process. the latter powershell injects a shellcode into its own process using well-known createthread and virtualalloc techniques: the shellcode phase of this attack is unique and demonstrates the constantly advancing abilities of attackers. the shellcode is the primary differentiating technique between this campaign and past attacks by fin7 and other threat actors. this shellcode iterates over process environment block and looks immediately for name (xor 13) and its dnsquerya function. basically, fin7 implemented a shellcode that gets the next stage shellcode using the dns messaging technique directly from memory. this way they can successfully evade many of the behavior based solutions. in the dns query pattern, it is very clear to see that alphabetical modification of the subdomain prefix is used: each such dns query results in an additional snippet of shellcode being appended to a reallocated buffer. when, finally, the first stage shellcode receives a special ff signal, it then executes the delivered shellcode. (it takes a few minutes for the dns queries to finish. the last query is to the subdomain ihc[.]stage[.]12019683[.]ns2[.]true-deals[.]com): the delivered second stage shellcode is encrypted: after decryption of the second stage shellcode, the shellcode deletes the mz prefix from within a very important part of the shellcode. this prefix indicates it may be a dll, and its deletion helps the attack to evade memory scanning solutions. just before this step executed, we extracted the dll from memory and uploaded it to virustotal. if this dll was saved on disk, many security solutions would immediately identify it as a cobaltstrike meterpreter, which is used by many attackers and pen testers. having a meterpreter session on a compromised computer allows for full control of the computer and exfiltration of any data, and in some cases lateral movement inside the organization. conclusions:
fin7 constantly upgrades their attacks and evasion techniques, thus becoming even more dangerous and unpredictable. the analysis of this attack shows, how easy it is for them to bypass static, dynamic and behavior based solutions. these attacks pose a severe risk to enterprises. fileless attacks are on the rise carbon black reports that researchers found a 33% rise in severe non-malware attacks in q4 2016 compared to q1. defenders will see more attacks on their businesses by hacker groups utilizing memory for evasion while keeping executable artifacts far away from disk. in this continuously evolving threat landscape, enterprises need to look for new defenses that are resilient to such changes and are able to prevent fileless attacks. morphisec endpoint threat prevention specializes in preventing in-memory attacks, using moving target defense to make the target itself unpredictable.
