fin7/carbanak threat actor unleashes bateleur jscript backdoor
july 31, 2017
matthew mesa, darien huss overview proofpoint researchers have uncovered that the threat actor commonly referred to as fin7 has added a new jscript backdoor called bateleur and updated macros to its toolkit. we have observed these new tools being used to target u.s.-based chain restaurants, although fin7 has previously targeted hospitality organizations, retailers, merchant services, suppliers and others. the new macros and bateleur backdoor use sophisticated anti-analysis and sandbox evasion techniques as they attempt to cloak their activities and expand their victim pool. specifically, the first fin7 change we observed was in the obfuscation technique found in their usual document attachments delivering the ggldr script [1], initially described by researchers at fireeye [2]. in addition, starting in early june, we observed this threat actor using macro documents to drop a previously undocumented jscript backdoor, which we have named bateleur , instead of dropping their customary ggldr payload. since its initial sighting, there have been multiple updates to bateleur and the attachment macros. in this blog we take a deep dive into bateleur and the email messages and documents delivering it. delivery the example message (fig. 1) uses a very simple lure to target a restaurant chain. it purports to be information on a previously discussed check. the email is sent from an account, and the attachment document lure also matches that information by claiming this document is encrypted by outlook protect service . in other cases, when the message was sent from a gmail account, the lure document instead claims this document is encrypted by google documents protect service (fig. 2). analysis the email contains a macro-laden word document. the macro accesses the malicious payload via a caption: userform1.label1.caption (fig. 3). the caption contains a |*| -delimited obfuscated jscript payload (fig. 4). the macro first extracts the jscript from the caption then saves the content to in the current user s temporary folder (%tmp%). next, the macro executes the following commands, which are stored in an obfuscated manner by reversing the character order: in the first step, the macro creates a scheduled task whose purpose is to execute as a jscript. the macro then sleeps for 3 seconds, after which it runs the scheduled task. finally, the macro sleeps for 10 seconds then deletes the malicious scheduled task. the combined effect of these commands is to run bateleur on the infected system in a roundabout manner in an attempt to evade detection. the malicious jscript has robust capabilities that include anti-sandbox functionality, anti-analysis (obfuscation), retrieval of infected system information, listing of running processes, execution of custom commands and powershell scripts, loading of exes and dlls, taking screenshots, uninstalling and updating itself, and possibly the ability to exfiltrate passwords, although the latter requires an additional module from the command and control server (c&c). when bateleur first executes it creates a scheduled task googleupdatetaskmachinesystem for persistence using the following command pattern:
bateleur has anti-sandbox features but they do not appear to be used at this time. this includes detection of virtualbox, vmware, or parallels via smbiosbiosversion and any of the following strings in deviceid: command description get_information return various information about the infected machine, such as computer and domain name, os, screen size, and net view get_process_list return running process list (name + id) kill_process kill process using taskkill uninstall delete installation file and path and remove scheduled task googleupdatetaskmachinesystem update overwrite jscript file with response content exe perform a load_exe request to the c&c to retrieve an exe, save it as debug.backup in the install_path, write a command to a file named debug.cmd and then execute debug.cmd with wexe perform a load_exe request to c&c to retrieve an exe, save it as and then execute the exe via wmi dll perform a load_dll request to the c&c to retrieve a dll, save it as debug.backup in the install_path, write a regsvr32 command to a file named debug.cmd and then execute debug.cmd with cmd perform a load_cmd request to the c&c to retrieve a command to execute, create temp file named log_[date].cmd containing command to execute, execute the command and sleep for 55 seconds. send file output to the c&c via a post request and remove the temporary command file powershell perform a load_powershell request to the c&c to retrieve a command to execute, create a temp file named containing a powershell command to execute, execute the command, and sleep for 55 seconds. send file output to the c&c via a post request and remove the temporary command file apowershell same as powershell command but instead executes a powershell command directly with wpowershell same as powershell command but instead executes a powershell command via wmi get_screen take a screenshot and save it as in the install_path get_passwords perform a load_pass request to the c&c to retrieve a powershell command containing a payload capable of retrieving user account credentials timeout do nothing table 1: list of commands available in the bateleur backdoor the bateleur c&c protocol occurs over https and is fairly straightforward with no additional encoding or obfuscation. bateleur uses http post requests with a uri of /?page=wait while the backdoor is waiting for instructions. once an instruction is received from the controller (fig. 5), the backdoor will perform a new request related to the received command (fig. 6). after each command the backdoor will respond with typically either an ok for many commands, or send the results back to the c&c with a final post request. although bateleur has a much smaller footprint than ggldr/halfbaked, lacks basic features such as encoding in the c&c protocol, and does not have backup c&c servers, we expect the bateleur developer(s) may add those features in the near future. in less than one month, we have observed bataleur jump from version 1.0 to ; the newer version of the backdoor adds several new commands including the wexe, apowershell, and wpowershell (table 1) that did not exist in version 1.0. attribution proofpoint researchers have determined with a high degree of certainty that this backdoor is being used by the same group that is referred to as fin7 by fireeye [3] and as carbanak by trustwave [4] and others. in this section we will discuss each datapoint that connects this backdoor with previous fin7 activity. email message/campaign similarity in june we observed similar messages separately delivering ggldr and bateleur to the same target, with some even sharing very similar or identical attachment names, subject lines, and/or sender addresses. the timing and similarity between these campaigns suggest that they were sent by the same actor. tinymet a small meterpreter downloader script, called tinymet by the actor(s) (possibly inspired by [5]), has repeatedly been observed being utilized by this group at least as far back as 2016 [6] as a stage 2 payload. in at least one instance, we observed bateleur downloading the same tinymet meterpreter downloader (fig. 7). figure 7 moreover, the ggldr/halfbaked backdoor was recently equipped with a new command tinymet (fig. 8) which was used in at least one occasion (fig. 9) to download a jscript version of the tinymet meterpreter downloader (fig. 10). we have also observed tinymet delivered via the runps1 (fig. 11) and runvbs (fig. 12) commands, resulting in the same version of tinymet downloaded by bateleur (fig. 13). all observed instances of tinymet have utilized the same xor key of 0x50. conclusion we continue to see regular changes to the tactics and tools used by fin7 in their attempt to infect more targets and evade detection. the bateleur jscript backdoor and new macro-laden documents appear to be the latest in the group s expanding toolset, providing new means of infection, additional ways of hiding their activity, and growing capabilities for stealing information and executing commands directly on victim machines.
